<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>AdminLTE 3 | Data Tables</title>
    <!-- Tell the browser to be responsive to screen width -->
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="/static/plugins/font-awesome/css/font-awesome.min.css">
    <!-- Ionicons -->
    <link rel="stylesheet" href="/static/dist/css/ionicons.min.css">
    <!-- DataTables -->
    <link rel="stylesheet" href="/static/plugins/datatables/dataTables.bootstrap4.css">
    <!--link rel="stylesheet" href="/static/plugins/datatables/jquery.dataTables.css"-->
    <!-- Theme style -->
    <link rel="stylesheet" href="/static/dist/css/adminlte.min.css">
    <link rel="stylesheet" href="/static/plugins/iCheck/all.css">
    <style>
        img {
            height: 35px;
            width: 35px;
        }

        #img_show img {
            width: 80px;
            height: 80px;
            border: 1px solid #ddd;
        }

        #img_show img:hover {
            -webkit-transform: scale(1.1); /*放大1.2倍*/
            transform: scale(1.1); /*放大1.2倍*/
            z-index: 999;
        }

        #img_show div {
            margin-bottom: 10px;
            text-align: center;
        }

        .task_dialog {
            height: 550px;
            overflow: auto;
        }

        .file-upload-img {
            display: inline-block;
            width: 80px;
            height: 80px;
            line-height: 70px;
            text-align: center;
            background: #f2f2f2;
            border: 1px solid #ddd;
            font-size: 36px;
            color: #b0b0b0;
            cursor: pointer;
            position: relative;
        }

        /*隐藏默认样式*/
        .file-button {
            z-index: 999;
            position: absolute;
            width: 80px;
            height: 80px;
            display: inline-block;
            opacity: 0;
            cursor: pointer;
            left: 5px;
        }

        .addline {
            width: 40px;
            height: 2px;
            position: absolute;
            top: 0;
            bottom: 28px;
            left: 0;
            right: 0;
            margin: auto;
            background: #b0b0b0;
        }

        .addline:nth-of-type(2) {
            transform: rotate(90deg)
        }
    </style>
</head>


<body class="hold-transition sidebar-mini">
<!-- Main content -->
<section class="content">
    <div class="row" style="margin-top:20px;margin-left:1px;">
        <div class="input-group col-2">
            <div class="input-group-prepend">
                <span class="input-group-text"><i class="fa fa-weixin btn-outline-success fa-lg"></i></span>
            </div>
            <select id="wx_id_query" class="form-control select2 select2-hidden-accessible" tabindex="-1"
                    aria-hidden="true"></select>
        </div>
        <div class="input-group col-2">
            <div class="input-group-prepend">
                <span class="input-group-text"><i class="fa fa-mobile-phone  fa-lg"></i></span>
            </div>
            <input id="phoneId" type="text" class="form-control" placeholder="手机号码">
        </div>
        {#    20181108 屏蔽#}
        {#      <div class="input-group-append col-2">#}
        {#            <span class="input-group-text"><i class="fa fa-group  fa-lg"></i></span>#}
        {#            <select id="groupId" class="form-control select2 select2-hidden-accessible" tabindex="-1" aria-hidden="true">#}
        {#              <option selected="selected">营销分组</option>#}
        {#                {% for  key, value in groupIdList %}#}
        {#                    <option value={{value}}>{{key}}</option>#}
        {#                {% endfor %}#}
        {#            </select>#}
        {#          <!--<input id="groupId" type="text" class="form-control" placeholder="营销分组">-->#}
        {#      </div>#}
        <div class="input-group-append col-2">
            <span class="input-group-text"><i class="fa fa-hourglass-start fa-lg"></i></span>
            <select id="typeId" class="form-control select2 select2-hidden-accessible" tabindex="-1" aria-hidden="true">
                <option selected="selected" value="0">任务类型</option>
                {% for  key, value in taskTypeList %}
                    <option value={{ value }}>{{ key }}</option>
                {% endfor %}
                <!--<option value="1">添加好友</option>-->
                <!--<option value="2">养号聊天</option>-->
                <!--<option value="4">朋友圈(原创)</option>-->
                <!--<option value="3">朋友圈(转发)</option>-->
                <!--<option value="5">聊天营销</option>-->
            </select>
            <!--<input id="groupId" type="text" class="form-control" placeholder="营销分组">-->
        </div>
        <div class="input-group-append col-2">
            <span class="input-group-text"><i class="fa fa-bolt fa-lg"></i></span>
            <select id="statusId" class="form-control select2 select2-hidden-accessible" tabindex="-1"
                    aria-hidden="true">
                <option selected="selected">任务状态</option>
                {% for  key, value in taskStatusList %}
                    <option value={{ value }}>{{ key }}</option>
                {% endfor %}
                <!--<option value="0">初始化</option>-->
                <!--<option value="1">下发中</option>-->
                <!--<option value="2">执行中</option>-->
                <!--<option value="4">完成</option>-->
                <!--<option value="3">失败</option>-->
                <!--<option value="5">暂停</option>-->

            </select>
            <!--<input id="groupId" type="text" class="form-control" placeholder="营销分组">-->
        </div>
        <div class="col-1">
            <button class="btn btn-primary" onclick="queryWxTask(1,'Search')"><i class="fa fa-search"></i> 查询</button>
        </div>
    </div>
    <div class="row" style="margin-top:20px;margin-left:1px;">
        <button class="btn btn-app" onclick="taskAction(type='start')"><i class="fa fa-caret-square-o-right"></i> 任务启动
        </button>
        <button class="btn btn-app" id="taskStopnAction" onclick="taskAction(type='stop')" data-toggle="modal"
                data-target="#Modal_taskStop"><i class="fa fa-pause"></i> 任务暂停
        </button>
        <button class="btn btn-app" id="taskDelAction" onclick="taskAction(type='del')" data-toggle=""
                data-target="#Modal_taskDel"><i class="fa fa-trash"></i> 任务删除
        </button>
{#        20190226屏蔽#}
{#        <button class="btn btn-app" id="addFriednAction" onclick="wxAccountInfoQuery('addFriend')" data-toggle="modal"#}
{#                data-target="#Modal_addFriend"><i class="fa fa-user-plus"></i> 好友添加#}
{#        </button>#}
        <button class="btn btn-app" id="randomChatAction" data-toggle="modal" onclick="wxAccountInfoQuery('randomChat')"
                data-target="#Modal_randomChat"><i class="fa fa-comment"></i> 养号聊天
        </button>
        <button class="btn btn-app" id="commentAction" data-toggle="modal" onclick="wxAccountInfoQuery('comment')"
                data-target="#Modal_comment"><i class="fa fa-yelp"></i> 朋友圈
        </button>
    </div>
</section>

<section class="content">
    <div class="col-md-12" style="margin-top:20px;">
        <div class="card">
            <div class="card-body">
                <table class="table table-striped">
                    <thead>
                    <tr>
                        <th><input type="checkbox" id="allItem" name="allItem" value=""/></th>
                        <th>微信号</th>
                        <th>微信昵称</th>
                        <th>任务类型</th>
                        <th>开始时间</th>
                        <th>结束时间</th>
                        <th>任务状态</th>
                        <th>出错原因</th>
                    </tr>
                    </thead>
                    <tbody id="wxTask">

                    </tbody>
                </table>
            </div><!-- /.card-body -->
        </div>
        <div id="example2_wrapper" class="dataTables_wrapper container-fluid dt-bootstrap4">
            <div class="row">
                <div class="col-2">
                    <div class="dataTables_info" id="userListTable_info" role="status" aria-live="polite"></div>
                </div>
                <div class="col-1">
                    <div class="dataTables_info" id="div_pageSize" role="status" aria-live="polite"></div>
                </div>
                <div class="col-2">
                    <div class="dataTables_info input-group" id="div_button" role="status" aria-live="polite"></div>
                </div>
                <div class="col-7" style="margin-top: 8px;">
                    <div class="dataTables_paginate" id="userListTable_paginate">
                        <ul class="pagination" id="page"></ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!--modal start-->
<!--addFriend-->
<div class="modal fade" id="Modal_addFriend" tabindex="-1" role="dialog" aria-labelledby="Modal_addFriend"
     aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="card card-primary task_dialog">
                <div class="card-header">
                    <h4 class="card-title">好友添加</h4>
                </div>
                <div class="card-body">
                    <!--main-->
                    <div class="container">
                        <div class="row clearfix">
                            <div class="col-md-7 column">
                                <!--过滤-->
                                <div class="container">
                                    <div class="row clearfix">
                                        <div class="input-group">
                                            <input id="filter_AF" type="text" class="form-control" placeholder="Search">
                                            <div class="input-group-prepend">
                                                <button class="btn btn-primary"
                                                        onclick="filterAction('filter_AF','addFriend')"><i
                                                        class="fa fa-search"></i></button>
                                                <button class="btn btn-primary"
                                                        onclick="filterAction('filter_AF','addFriend','1')"><i
                                                        class="fa fa-undo"></i></button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <section class="content">
                                    <div style="margin-top:20px;">
                                        <div class="card">
                                            <table class="table table-striped" id="addFriend">
                                            </table>
                                        </div>
                                    </div>
                                </section>
                            </div>

                            <div class="col-md-5 column">
                                <h3 class="text-info text-center">添加好友设置</h3>
                                <div class="input-group">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text"><i class="fa  fa-phone  fa-lg"></i></span>
                                    </div>
                                    <input id="sayHi" type="text" class="form-control" placeholder="招呼术语">
                                </div>
                                <div class="input-group" style="padding-top:10px;">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text"><i class="fa  fa-minus-circle fa-lg"></i></span>
                                    </div>
                                    <input id="friendNumMax" type="text" class="form-control" placeholder="每日上限个数">
                                </div>
                                <div class="form-group" style="padding-top:10px;">
                                    <div class="row">
                                        <div class="col-4">
                                            <label>目标号码</label>
                                        </div>
                                    </div>
                                    <textarea id="wxIdList" class="form-control" rows="3"
                                              placeholder="Enter...."></textarea>
                                </div>
                                <input type="file" id="fileImport" accept="text/plain"
                                       onchange="fileImport(this.files)"/>
                            </div>
                        </div>
                    </div>
                    <!--main end-->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal" onclick="createTaskClear()">关闭
                </button>
                <button type="button" class="btn btn-primary" onclick="createWxTask('addFriend')">创建</button>
            </div>
        </div>
    </div>
</div>

<!--Modal_boot-->
<div class="modal fade" id="Modal_boot" tabindex="-1" role="dialog" aria-labelledby="Modal_boot" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="card card-primary task_dialog">
                <div class="card-header">
                    <h4 class="card-title">容器启停</h4>
                </div>
                <div class="card-body">
                    <!--main-->
                    <div class="container">
                        <div class="container">
                            <div class="row clearfix">
                                <div class="col-md-8 column">
                                </div>
                                <div class="col-md-4 column">
                                    <div class="input-group">
                                        <input id="filter_boot" type="text" class="form-control" placeholder="Search">
                                        <div class="input-group-prepend">
                                            <button class="btn btn-primary"
                                                    onclick="filterAction('filter_boot','boot')"><i
                                                    class="fa fa-search"></i></button>
                                            <button class="btn btn-primary"
                                                    onclick="filterAction('filter_boot','boot','1')"><i
                                                    class="fa fa-undo"></i></button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row clearfix">
                            <div class="col-md-12 column">
                                <section class="content">
                                    <div style="margin-top:20px;">
                                        <div class="card">
                                            <table class="table table-striped" id="boot">

                                            </table>
                                        </div>
                                    </div>
                                </section>
                            </div>
                        </div>
                    </div>
                    <!--main end-->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal" onclick="createTaskClear()">关闭
                </button>
                <button type="button" class="btn btn-primary" onclick="createWxTask('boot','start')">启动容器</button>
                <button type="button" class="btn btn-primary" onclick="createWxTask('boot','stop')">关闭容器</button>
            </div>
        </div>
    </div>
</div>

<!--randomChat-->
<div class="modal fade" id="Modal_randomChat" tabindex="-1" role="dialog" aria-labelledby="Modal_randomChat"
     aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="card card-primary task_dialog">
                <div class="card-header">
                    <h4 class="card-title">养号聊天</h4>
                </div>
                <div class="card-body">
                    <!--main-->
                    <div class="container">
                        <div class="container">
                            <div class="row clearfix">
                                <div class="col-md-8 column">
                                </div>
                                <div class="col-md-4 column">
                                    <div class="input-group col-12">
                                        <input id="filter_RC" type="text" class="form-control" placeholder="Search">
                                        <div class="input-group-prepend">
                                            <button class="btn btn-primary"
                                                    onclick="filterAction('filter_RC','randomChat')"><i
                                                    class="fa fa-search"></i></button>
                                            <button class="btn btn-primary"
                                                    onclick="filterAction('filter_RC','randomChat','1')"><i
                                                    class="fa fa-undo"></i></button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row clearfix">
                            <div class="col-md-12 column">
                                <section class="content">
                                    <div class="col-md-12">
                                        <div class="card">
                                            <table class="table table-striped" id="randomChat">
                                            </table>
                                        </div>
                                    </div>
                                </section>
                            </div>
                        </div>
                    </div>
                    <!--main end-->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal" onclick="createTaskClear()">关闭
                </button>
                <button type="button" class="btn btn-primary" onclick="createWxTask('randomChat')">创建</button>
            </div>
        </div>
    </div>
</div>

<!--comment-->
<div class="modal fade" id="Modal_comment" tabindex="-1" role="dialog" aria-labelledby="Modal_comment"
     aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="card card-primary task_dialog">
                <div class="card-header">
                    <h4 class="card-title">朋友圈</h4>
                </div>
                <div class="card-body">
                    <div class="container">
                        <div class="row clearfix">
                            <div class="col-7">
                                <!--过滤-->
                                <div class="container">
                                    <div class="row clearfix">
                                        <div class="input-group ">
                                            <input id="filter_CO" type="text" class="form-control" placeholder="Search">
                                            <div class="input-group-prepend">
                                                <button class="btn btn-primary"
                                                        onclick="filterAction('filter_CO','comment')"><i
                                                        class="fa fa-search"></i></button>
                                                <button class="btn btn-primary"
                                                        onclick="filterAction('filter_CO','comment','1')"><i
                                                        class="fa fa-undo"></i></button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <section class="content">
                                    <div style="margin-top:20px;">
                                        <div class="card">
                                            <table class="table table-striped" id="comment">
                                            </table>
                                        </div>
                                    </div>
                                </section>
                            </div>
                            <div class="col-5">
                                <div class="row">
                                    <div class="col-6">
                                        <label>
                                            <input id="commentType_O" name="commentType" type="radio" value="0"
                                                   onclick="$('#commentUrl').hide();$('#img_show').show()"
                                                   checked="checked"/><span style="margin-left: 10px">原创文章 </span>
                                        </label>
                                    </div>
                                    <div class="col-6">
                                        <label>
                                            <input id="commentType_T" name="commentType"
                                                   onclick="$('#commentUrl').show();$('#img_show').hide();" type="radio"
                                                   value="1"/><span style="margin-left: 10px">转发文章</span>
                                        </label>
                                    </div>
                                </div>

                                <div class="input-group" style="padding-top:10px;display: none;" id="commentUrl">
                                    <input id="commentTransUrl" type="text" class="form-control" placeholder="转发链接">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text"><i class="fa  fa-link fa-lg"></i></span>
                                    </div>
                                </div>

                                <div class="form-group" style="padding-top:20px;">
                                    <textarea id="commentContent" class="form-control" rows="3"
                                              placeholder="这一刻的想法..."></textarea>
                                </div>

                                <div class="row" id="img_show">
                                    <div class="col-4" id="img_upload_file">
                                        <div class="file-upload-img" id="upFile">
                                            <div class="addline"></div>
                                            <div class="addline"></div>
                                        </div>
                                        <input class="file-button" multiple accept="image/png, image/jpeg, image/jpg,"
                                               type="file" name="imgfiles" id="file_upload">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal" onclick="createTaskClear()">关闭
                </button>
                <button type="button" class="btn btn-primary" onclick="createWxTask('comment')">发表</button>
            </div>
        </div>
    </div>
</div>

<!--task stop modal-->
<div class="modal fade" id="Modal_taskStop" tabindex="-1" role="dialog" aria-labelledby="Modal_randomChat"
     aria-hidden="true">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="card card-primary">
                <div class="card-header">
                    <h4 class="card-title">任务暂停</h4>
                </div>
                <div class="card-body">
                    <!--main-->
                    <div class="container">
                            <span id="stopTypeContent">

                            </span>
                        <!--main end-->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="taskStop()">确定</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!--del modal-->
<div class="modal fade" id="Modal_taskDel" tabindex="-1" role="dialog" aria-labelledby="Modal_taskDel"
     aria-hidden="true">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="card card-primary">
                <div class="card-header">
                    <h4 class="card-title">任务删除</h4>
                </div>
                <div class="card-body">
                    <!--main-->
                    <div class="container">
                            <span id="delTypeContent">
                                即将删除选中任务
                            </span>
                        <!--main end-->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="taskDel()">确定</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!--modal end-->
</div>
</body>
</html>

<!-- ./wrapper -->
<script src="/static/js/common.js"></script>
<!-- jQuery -->
<script src="/static/plugins/jquery/jquery.js"></script>
<!-- Bootstrap 4 -->
<script src="/static/plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
<!-- DataTables -->
<script src="/static/plugins/datatables/jquery.dataTables.js"></script>
<script src="/static/plugins/datatables/dataTables.bootstrap4.js"></script>
<!-- SlimScroll -->
<script src="/static/plugins/slimScroll/jquery.slimscroll.min.js"></script>
<!-- FastClick -->
<script src="/static/plugins/fastclick/fastclick.js"></script>
<!-- AdminLTE App -->
<script src="/static/dist/js/adminlte.min.js"></script>
<script src="/static/plugins/iCheck/icheck.min.js"></script>
<!-- page script -->
<script src="/static/page.js"></script>
<script src="/static/js/jQuery/jquery.ui.widget.js"></script>
<script src="/static/js/jQuery/jquery.fileupload.js"></script>
<script>
    $(function () {
        queryWxTask(1, checkType = 'Normal');
        getWxId();
    });

    function getWxId() {
        $.ajax({
                    type: "POST",
                    dataType: 'json',
                    url: "{% url 'getWxId' %}",
                    data: {},
                    success: function (data) {
                        console.info(data);
                        var xuanxiangzhi = ""
                        wx_info_list = data.data;
                        var htmlcontent = "<option>全部</option>";
                        $.each(wx_info_list, function (key, wx_info) {
                            xuanxiangzhi = wx_info.wx_name + "(" + wx_info.wx_login_id + ")";
                            htmlcontent += "<option value='" + wx_info.wx_id + "' img='" + wx_info.head_picture + "'>" + xuanxiangzhi + "</option>";
                        });
                        $("#wx_id_query").empty().append(htmlcontent);
                        $("#wx_id").empty().append(htmlcontent);
                    }
                }
        );
    }

    function isNumber(value) {
        var patrn = /^(-)?\d+(\.\d+)?$/;
        if (patrn.exec(value) == null || value == "") {
            return false
        } else {
            return true
        }
    }
    function queryWxTask(pageIndex, checkType) {
        checkType = typeof checkType !== 'undefined' ? checkType : 'Normal';
        var pageShowNum = $("#pageSize_value option:selected").val();
        if (pageShowNum == undefined) {
            pageShowNum = 5
        }
        var wxCheckId =  ($("#wx_id_query").val()=='全部')?'':$("#wx_id_query").val();
        var phCheckId = document.getElementById('phoneId').value; // 手机号
        var groupCheckId = $("#groupId option:selected").val(); // 营销分组
        var groupCheckId = "营销分组"; // 营销分组
        var typeCheckId = $("#typeId option:selected").val() // 任务类型
        var statusCheckId = $("#statusId option:selected").val(); // 任务状态
        if (checkType == 'Search') {
            if (wxCheckId == "" && phCheckId == "" && groupCheckId == "营销分组" && typeCheckId == "任务类型" && statusCheckId == "任务状态") {
                alert("请至少选择一种查询条件")
            }
        }
        $.ajax({
            url: "{% url 'queryWxTask' %}",
            type: "GET",
            data: {
                "pageIndex": pageIndex,
                "wxCheckId": wxCheckId,
                "phCheckId": phCheckId,
                "groupCheckId": groupCheckId,
                "typeCheckId": typeCheckId,
                "statusCheckId": statusCheckId,
                "pageShowNum": pageShowNum
            },
            success: function (data) {
                severcheck(data);
                data = parseJson(data);
                if (data) {
                    tempHtml = '';
                    for (key in data) {
                        if (isNumber(key)) {
                            var checkValue = data[key]["taskSeq"] + ',' +
                                    data[key]["wx_id"] + ',' +
                                    data[key]["task_type"] + ',' +
                                    data[key]["status"];

                            tempHtml += '<tr><td><input type=\"checkbox\" id="allItem" name=\"allItem_FD\" value=\"' + checkValue + '\"/></td>';
                            tempHtml += "<td>" + data[key]["wx_id"] + "</td>";
                            tempHtml += "<td>" + data[key]["wx_name"] + "</td><td>" + data[key]["task_type_name"] + "</td>"
                            tempHtml += "<td>" + data[key]["start_time"] + "</td>"
                            // tempHtml += "<td>" + data[key]["task_type"] + "</td>"
                            // tempHtml += "<td>" + data[key]["create_time"] + "</td>"

                            tempHtml += "<td>" + data[key]["end_time"] + "</td>"
                            if (data[key]["status"] == 0) {
                                tempHtml += "<td><span class=\"badge bg-warning\">初始化</span></td>"
                                tempHtml += "<td></td>"
                            } else if (data[key]["status"] == 1) {
                                tempHtml += "<td><span class=\"badge bg-primary\">下发中</span></td>"
                                tempHtml += "<td></td>"
                            } else if (data[key]["status"] == 2) {
                                tempHtml += "<td><span class=\"badge bg-warning\">执行中</span></td>"
                                tempHtml += "<td></td>"
                            } else if (data[key]["status"] == 4) {
                                tempHtml += "<td><span class=\"badge bg-success\">完成</span></td>"
                                tempHtml += "<td></td>"
                            } else if (data[key]["status"] == 3) {
                                tempHtml += "<td title=\"" + data[key]["taskRemarks"] + "\"><span class=\"badge bg-danger\">失败</span></td>"
                                tempHtml += "<td><span class='js-title' title='" + data[key]["taskRemarks"] + "' style='display:inline-block;width:150px;overflow: hidden;white-space: nowrap;text-overflow: ellipsis;'>" + data[key]['taskRemarks'] + "</span></td>"
                            } else if (data[key]["status"] == 5) {
                                tempHtml += "<td><span class=\"badge bg-warning\">暂停</span></td>"
                                tempHtml += "<td></td>"
                            } else if (data[key]["status"] == 6) {
                                tempHtml += "<td><span class=\"badge bg-warning\">失败(微信登出)</span></td>"
                                tempHtml += "<td><span class='js-title' title='" + data[key]["taskRemarks"] + "' style='display:inline-block;width:150px;overflow: hidden;white-space: nowrap;text-overflow: ellipsis;'>" + data[key]['taskRemarks'] + "</span></td>"
                            } else {
                                tempHtml += "<td><span class=\"badge bg-warning\">未知</span></td>"
                                tempHtml += "<td><span class='js-title' title='" + data[key]["taskRemarks"] + "' style='display:inline-block;width:150px;overflow: hidden;white-space: nowrap;text-overflow: ellipsis;'>" + data[key]['taskRemarks'] + "</span></td>"
                            }

                            tempHtml += "</tr>";
                        }

                    }
                    $("#wxTask").html(tempHtml);

                    $(("[type='checkbox'][name='allItem_FD']")).iCheck({
                        checkboxClass: 'icheckbox_square-blue',
                        radioClass: 'iradio_square-blue'
                    });

                    //全选
                    $('#allItem').on('ifChecked', function (event) {
                        $("input[name='allItem_FD']").iCheck('check');
                    });
                    //反选
                    $('#allItem').on('ifUnchecked', function (event) {
                        $("input[name='allItem_FD']").iCheck('uncheck');
                    });
                }
                page = {'total': data['countNum'], 'pageNum': pageIndex, 'pages': data['pageCount']}
                setPage(page, "queryWxTask", "show");
            }
        });
    }

    function taskAction(type) {
        var chkValueLen = $('input[name="allItem_FD"]:checked').length
        if (chkValueLen == 0 && type != "stop") {
            alert("请至少选择一行内容")
        }
        else {
            if (type == "start") {
                startFlag = 1
                start_statusTmp = []
                $('input[name="allItem_FD"]:checked').each(function () {
                    start_thisValue = $(this).val();
                    start_actionStatus = start_thisValue.split(',')[3];
                    if (start_actionStatus == 2 || start_actionStatus == 1) {
                        startFlag = -1
                    }
                });
                //开始流程
                if (startFlag == 1) {
                    startValueString = ""
                    $('input[name="allItem_FD"]:checked').each(function () {
                        // startValueArray.push($(this).val())
                        startValueString = $(this).val() + ',' + startValueString
                    })
                    $.ajax({
                        url: "{% url 'startWxTask' %}",
                        type: "GET",
                        data: {"startValue": startValueString},
                        success: function (data) {
                            severcheck(data);
                            data = parseJson(data);
                            if (data['retStatus'] == 1) {
                                alert("任务下发成功，启动中")
                                // 返回首页
                                document.location.reload();
                            }
                            else if (data['retStatus'] == -1) {
                                alert("当前存在其他类任务下发或执行中，请先暂停后执行")
                            }
                            else {
                                alert("任务下发失败")
                            }
                        }
                    })
                }
                else {
                    alert("当前选择存在正在执行或下发任务，请暂停其他任务")
                }
            }
            else if (type == "stop") {
                document.getElementById("taskStopnAction").setAttribute("data-toggle", "modal")
                var chkValueLen = $('input[name="allItem_FD"]:checked').length
                if (chkValueLen == 0) {
                    document.getElementById("stopTypeContent").innerText = "未选中任何任务，将暂停全部任务";
                } else {
                    stopFlag = 1
                    stopt_statusTmp = []
                    $('input[name="allItem_FD"]:checked').each(function () {
                        start_thisValue = $(this).val();
                        start_actionStatus = start_thisValue.split(',')[3];
                        if (start_actionStatus == 3 || start_actionStatus == 4) {
                            stopFlag = -1
                            alert("存在已完成任务，无法暂停")
                            return false;
                        }
                    });
                    if (stopFlag == 1) {
                        document.getElementById("stopTypeContent").innerText = "即将暂停选中任务";
                    } else {
                        document.getElementById("taskStopnAction").setAttribute("data-toggle", "")
                    }
                }

            }
            else if (type == "del") {
                delFlag = 1
                del_statusTmp = []
                retStatus = 1
                del_chkList = $('input[name="allItem_FD"]:checked').each(function () {
                    del_thisValue = $(this).val()
                    del_actionStatus = del_thisValue.split(',')[3]
                    if (del_actionStatus == 2 || del_actionStatus == 1) {
                        delFlag = -1
                    }
                })
                if (delFlag == 1) {
                    document.getElementById("taskDelAction").setAttribute("data-toggle", "modal")

                } else {
                    document.getElementById("taskDelAction").setAttribute("data-toggle", "")
                    alert("存在正在执行或下发任务，请暂停任务")
                }
            }
        }
    }

    function unique(arr) {
        var result = [], hash = {};
        for (var i = 0, elem; (elem = arr[i]) != null; i++) {
            if (!hash[elem]) {
                result.push(elem);
                hash[elem] = true;
            }
        }
        return result;
    }
    function wxAccountInfoQuery(type, option, filterReg) {
        option = typeof option !== 'undefined' ? option : 'Normal';
        filterReg = typeof filterReg !== 'undefined' ? filterReg : "";
        $.ajax({
            url: "{% url 'wxAccountInfoQuery' %}",
            type: "GET",
            data: {},
            success: function (data) {
                severcheck(data);
                data = parseJson(data);
                if (data) {
                    var tempHtml = "<thead><tr>";
                    tempHtml += "<th><input type='checkbox' id='" + type + "0'name=" + type + " ></th>";
                    tempHtml += "<th>头像</th><th>微信号</th><th>微信昵称</th></tr><thead><tbody>";
                    for (key in data) {
                        if (isNumber(key)) {
                            var checkAccountValue = data[key]["head_picture"] + ',' + data[key]["wx_id"] + ','
                                    + data[key]["groupId"] + data[key]['wx_login_id'];
                            if (filterReg != "") {
                                if (checkAccountValue.search(filterReg) == -1) {
                                    continue;
                                }
                            }

                            tempHtml += '<tr><td><input type="checkbox"  name="' + type + '" value="' + checkAccountValue + '"/></td>';
                            tempHtml += "<td><img src='" + data[key]["head_picture"] + "' class='img-circle' /></td>";
                            tempHtml += "<td> <span title='" + data[key]["wx_login_id"] + "' style='display:inline-block;width:110px;overflow: hidden;white-space: nowrap;text-overflow: ellipsis;'>" + data[key]["wx_login_id"] + "</td>";
                            tempHtml += "<td>" + data[key]["wx_name"] + "</td>";
                            tempHtml += "</tr>";
                        }
                    }
                    tempHtml += "</tbody>";
                    $("#" + type).html(tempHtml);

                    $(("[type='checkbox']")).iCheck({
                        checkboxClass: 'icheckbox_square-blue',
                        radioClass: 'iradio_square-blue'
                    });

                    //全选
                    $("#" + type + "0").on('ifChecked', function (event) {
                        $('input[name="' + type + '"]').iCheck('check');
                    });

                    //反选
                    $("#" + type + "0").on('ifUnchecked', function (event) {
                        $('input[name="' + type + '"]').iCheck('uncheck');
                    });
                }
            }
        })
    }
    function createWxTask(type, flag) {
        if ($('input[name="' + type + '"]:checked').length == 0) {
            alert("请至少选择一行内容");
            return false;
        }

        if ("boot" != type) {
            $('input[name="' + type + '"]:checked').each(function () {
                var status = $(this).val().split(',')[3];
                if (status == '0') {
                    alert("存在微信终端未启动，请先启动");
                    return false;
                }
            });
        }

        createValueString = "";
        $('input[name="' + type + '"]:checked').each(function () {
            createValueString = $(this).val() + ',' + createValueString
        });
        wx_id_str = "";
        $('input[name="' + type + '"]:checked').each(function () {
            wx_id_str = $(this).val().split(',')[1] + ',' + wx_id_str;
        });

        if (type == "addFriend") {
            sayHi = document.getElementById('sayHi').value;
            friendNumMax = document.getElementById('friendNumMax').value;
            wxIdList = document.getElementById('wxIdList').value;
            if (sayHi == "") {
                alert("请完善招呼术语")
            } else if (wxIdList == "") {
                alert("请完善添加好友列表")
            } else {
                $.ajax({
                    url: "{% url 'addFriendTaskCreate' %}",
                    type: "GET",
                    data: {
                        "createTaskValue": createValueString,
                        "sayHi": sayHi,
                        "friendNumMax": friendNumMax,
                        "wxIdList": wxIdList,
                    },
                    success: function (data) {
                        severcheck(data);
                        data = parseJson(data);
                        if (data['retStatus'] == 1) {
                            alert("添加好友任务下发成功")
                            document.location.reload();
                        }
                        else {
                            alert("添加好友任务下发失败")
                        }
                    }
                })
            }
        } else if (type == "randomChat") {
            $.ajax({
                url: "{% url 'randomChatTaskCreate' %}",
                type: "GET",
                data: {"createTaskValue": createValueString},
                success: function (data) {
                    severcheck(data);
                    data = parseJson(data);
                    if (data['retStatus'] == 1) {
                        alert("养号聊天任务下发成功")
                        document.location.reload();
                    }
                    else {
                        alert("养号聊天任务下发失败")
                    }
                }
            })
        } else if (type == "comment") {
            //全部输入状态
            pickFileList = "";
            urlLinkInput = document.getElementById('commentTransUrl').value;
            typePick = $("input[name='commentType']:checked").val();
            commentContent = document.getElementById('commentContent').value;
            $('.img_show_div').each(
                    function (index, obj) {
                        if (pickFileList == "") {
                            pickFileList = $(obj).attr("data");
                        }
                        else {
                            pickFileList = pickFileList + "|" + $(obj).attr("data");
                        }
                    }
            );
            if (typePick == '0' && commentContent == "") {  //原创
                alert("请输你的想法");
                return false;
            } else if (typePick == '1' && urlLinkInput == "") {
                alert("请输入转发链接")
                return false;
            }
            if (commentContent.length > 1400) {
                alert("朋友圈文字内容过长，不能超过1400字！");
                return false;
            }
            $.ajax({
                url: "{% url 'commentTaskCreate' %}",
                type: "GET",
                data: {
                    "typePick": typePick,
                    "wx_id_str": wx_id_str,
                    "pickFileList": pickFileList,
                    "commentContent": commentContent,
                    "urlLinkInput": urlLinkInput
                },
                success: function (data) {
                    severcheck(data);
                    data = parseJson(data);
                    if (data['retStatus'] == 1) {
                        alert("朋友圈任务下发成功")
                        document.location.reload();
                    }
                    else {
                        alert("朋友圈任务下发失败");
                    }
                }
            });
        }
        else if (type == "boot") {
            $.ajax({
                url: "{% url 'bootTask' %}",
                type: "GET",
                data: {"flag": flag, "wx_id_str": wx_id_str},
                success: function (data) {
                    severcheck(data);
                    data = parseJson(data);
                    if (data['retStatus'] == 1) {
                        alert("任务添加成功");
                        document.location.reload();
                    }
                    else {
                        alert("任务添加失败");
                    }
                }
            })
        }
    }
    function createTaskClear() {
        queryWxTask(1, checkType = 'Normal');
    }

    function fileImport() {
        //获取读取我文件的File对象
        var selectedFile = document.getElementById('fileImport').files[0];
        var name = selectedFile.name;//读取选中文件的文件名
        var size = selectedFile.size;//读取选中文件的大小
        if (size > 5 * 1024 * 1024) {
            alert("文件(" + name + ")大于5MB");
            return false
        }

        var reader = new FileReader();//这是核心,读取操作就是由它完成.
        reader.readAsText(selectedFile);//读取文件的内容,也可以读取文件的URL
        reader.onload = function () {
            //当读取完成后回调这个函数,然后此时文件的内容存储到了result中,直接操作即可
            $("#wxIdList").append(this.result);
        }
    }

    (function () {
        $('#file_upload').fileupload({
            url: "{% url 'fileupload' %}",
            change: function (e, data) {//这个是选择文件的回调函数
                if (data.files.length > 9) {//这里是判断选择文件的个数,根据实际情况设置
                    alert("最多只能选择9张图片");
                    return false;
                }
                for (var i = 0; i < data.files.length; i++) {
                    if (data.files[i].size > 1024 * 1024 * 5) {
                        alert("图片" + data.files[i].name + "大于5MB");
                        return false;
                    }
                }
            },
            done: function (e, data) {
                if ($('.img_show_div').length >= 9) {
                    $('#img_upload_file').hide();
                    return false;
                }
                if (data && data.result) {
                    data = JSON.parse(data.result);
                    imgurl = "/static/tmpFile/img/" + data["data"]
                    imghtml = "<div class='col-4 img_show_div' name='imgvalue' data='" + data["data"] + "'><img src='" + imgurl + "'><i class='fa fa-trash-o' onclick='$(this).parent().remove();$(\"#img_upload_file\").show();'></i></div>";
                    $("#img_show").prepend(imghtml);
                    if ($('.img_show_div').length == 9) {
                        $('#img_upload_file').hide();
                    }
                }
            },
            fail: function () {
                alert('上传出错！');
            }
        });
    })();


    function filterAction(type, businame, undo) {

        undo = typeof undo !== 'undefined' ? undo : "-1";
        var filter = $("#" + type).val();
        alert(filter)
        if (filter != "") {
            wxAccountInfoQuery(businame, 'filter', filter)
        }
        if (undo == "1") {
            wxAccountInfoQuery(businame)
        }
    }

    function taskStop() {
        var chkValueLen = $('input[name="allItem_FD"]:checked').length
        if (chkValueLen == 0) {
            stopTypeFlag = "0"
            stopList = ""
        } else {
            stopTypeFlag = "1"
            stopList = ""
            $('input[name="allItem_FD"]:checked').each(function () {
                // startValueArray.push($(this).val())
                stopList = $(this).val() + ',' + stopList
            })
        }
        $.ajax({
            url: "{% url 'stopWxTask' %}",
            type: "GET",
            data: {
                "stopTypeFlag": stopTypeFlag,
                "stopList": stopList
            },
            success: function (data) {
                severcheck(data);
                data = parseJson(data);
                if (data['retStatus'] == 1) {
                    alert("已暂停指定任务")
                    // 返回首页
                    document.location.reload();
                }
                else {
                    alert("暂停任务存在故障")
                }
            }
        })
    }
    function taskDel() {
        delValueString = ""
        $('input[name="allItem_FD"]:checked').each(function () {
            // startValueArray.push($(this).val())
            delValueString = $(this).val() + ',' + delValueString
        })
        $.ajax({
            url: "{% url 'delWxTask' %}",
            type: "GET",
            data: {"delValue": delValueString},
            success: function (data) {
                severcheck(data);
                data = parseJson(data);
                if (data['retStatus'] == 1) {
                    retStatus = 1
                }
                else {
                    retStatus = -1
                }
            }
        })
        if (retStatus == 1) {
            alert("任务删除成功")
            document.location.reload();
        } else if (retStatus == -1) {
            alert("任务删除失败")
        }
    }
</script>