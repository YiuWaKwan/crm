<!DOCTYPE html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>慧聊</title>
    <!-- Tell the browser to be responsive to screen width -->
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/static/plugins/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="/static/dist/css/adminlte.min.css">
    <link rel="stylesheet" href="/static/plugins/datatables/dataTables.bootstrap4.css">
    <link rel="stylesheet" href="/static/plugins/iCheck/all.css">
    <link rel="stylesheet" href="/static/plugins/bootstrap/css/bootstrap-select.min.css">
    <link rel="stylesheet" href="/static/plugins/datepicker/datepicker3.css">
    <script src="/static/plugins/My97DatePicker/WdatePicker.js"></script>
    <style>
    .task_dialog{
        height: 550px;
        overflow: auto;
    }
    #img_show img{
            width:80px;
			height:80px;
            border: 1px solid #ddd;
        }
    #img_show img:hover{
            -webkit-transform: scale(5); /*放大1.2倍*/
            transform: scale(5); /*放大1.2倍*/
            z-index: 1002;
        }

        #img_show div{
            margin-bottom:10px;
			text-align: center;
        }
     .file-upload-img{
			display:inline-block;
			width:80px;
			height:80px;
			line-height:70px;
			text-align: center;
			background:#f2f2f2;
			border: 1px solid #ddd;
			font-size:36px;
			color:#b0b0b0;
			cursor:pointer;
            position: relative;
		}
		/*隐藏默认样式*/
		.file-button{
			z-index: 999;
            position: absolute;
            width: 80px;
            height: 80px;
            display: inline-block;
            opacity: 0;
            cursor:pointer;
            left: 5px;
		}

        .addline{
            width:40px;
            height:2px;
            position:absolute;
            top:0;
            bottom:28px;
            left:0;
            right:0;
            margin:auto;
            background:#b0b0b0;
        }
        .addline:nth-of-type(2) {
            transform: rotate(90deg)
        }
    </style>
</head>
<body class="hold-transition sidebar-mini">
<p id="loading" class="ico_loading" style="position: absolute;z-index: 9999;left: 40%;top: 20%;display: none"><img src="/static/img/wx/load.gif" >正在获取信息...</p>

<!-- Content Header (Page header) -->
<section class="content">
    <div class="row" style="margin-top:20px;margin-left:1px;">
        <div class="input-group col-2">
            <div class="input-group-prepend">
                <span class="input-group-text"><i class="fa fa-tv fa-lg"></i></span>
            </div>
            <input id="group_name_query" type="text" class="form-control" placeholder="群名称">
        </div>
        <div class="input-group col-2">
            <div class="input-group-prepend">
                <span class="input-group-text"><i class="fa fa-weixin fa-lg"></i></span>
            </div>
            <select id="wx_id_query" class="form-control select2 select2-hidden-accessible" tabindex="-1" aria-hidden="true"></select>
        </div>
        <div class="col-1">
            <button class="btn btn-primary" onclick="queryGroupInfo(1)"><i class="fa fa-search"></i> 查询
            </button>
        </div>

    </div>
    <div class="row" style="margin-top:20px;margin-left:1px;">
        <button class="btn btn-app " onclick="queryGroupTask()"><i class="fa fa-tasks"></i>任务情况</button>
        <button class="btn btn-app " onclick="$('#flag').val('insert');editGroup('insert')"><i class="fa fa-plus"></i>创建群聊</button>
        <button class="btn btn-app " onclick="$('#flag').val('add_member');editGroup('add_member')"><i class="fa fa-user-plus"></i>增加成员</button>
        <button class="btn btn-app " onclick="$('#flag').val('del_member');editGroup('del_member')"><i class="fa fa-user-times"></i>删减成员</button>
        <button class="btn btn-app " onclick="$('#flag').val('delete');editGroup('delete')"><i class="fa fa-trash"></i>解散群聊</button>
        <button class="btn btn-app " onclick="$('#flag').val('notice');editGroup('notice')"><i class="fa fa-commenting-o"></i>发布公告</button>
        <button class="btn btn-app " onclick="$('#flag').val('modify_name');editGroup('modify_name')"><i class="fa fa-info-circle"></i>更改昵称</button>
        <button class="btn btn-app " onclick="$('#flag').val('update_wx_id');editGroup('update_wx_id')"><i class="fa fa-exchange"></i>更换群主</button>
        <button class="btn btn-app " onclick="crontab()"><i class="fa fa-calendar-times-o"></i>定时计划</button>
    </div>
</section>

<!-- Main content -->
<section class="content">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body p-0">
                    <table id="example3" class="table table-striped table-hover">
                        <thead>
                            <tr style="text-align:center">
                                <th></th>
                                <th>群名称</th>
                                <th>主号昵称</th>
                                <th>群主</th>
                                <th>群公告</th>
                                <th>群人数</th>
                                <th>定时计划</th>
                            </tr>
                        </thead>
                        <tbody id="_tableId">
                        </tbody>
                    </table>
                </div>
            </div>
            <div id="example2_wrapper" class="dataTables_wrapper container-fluid dt-bootstrap4">
                <div class="row">
                    <div class="col-2">
                        <div class="dataTables_info" id="userListTable_info" role="status"
                             aria-live="polite"></div>
                    </div>
                    <div class="col-1">
                        <div class="dataTables_info" id="div_pageSize" role="status" aria-live="polite"></div>
                    </div>
                    <div class="col-2">
                        <div class="dataTables_info input-group" id="div_button" role="status"
                             aria-live="polite"></div>
                    </div>
                    <div class="col-7" style="margin-top: 8px;">
                        <div class="dataTables_paginate" id="userListTable_paginate">
                            <ul class="pagination" id="page"></ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<div class="modal fade" id="Modal_create" tabindex="-1" role="dialog" aria-labelledby="Modal_create" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="groupTitle">群信息</h4>
            </div>
            <div class="modal-body" style="height: 550px; overflow-y: auto">
                <input type='hidden' id='group_id'>
                <input type='hidden' id='flag'>
                <div class="row" style="margin-top: 10px;">
                    <div class="col-2" style="text-align: right">
                        <label>群名称<font color="red">*</font></label>
                    </div>
                    <div class="col-10">
                        <input type='text' class="form-control" id='group_name' placeholder="群名称(最长输入16个汉字)">
                    </div>
                </div>
                <div class="row" style="margin-top: 10px;">
                    <div class="col-2" style="text-align: right">
                        <label>群主<font color="red">*</font></label>
                    </div>
                    <div class="col-3">
                        <select id="wx_id" onchange="showSelect()" class="form-control select2 select2-hidden-accessible" tabindex="-1" aria-hidden="true"></select>
                        <select id="friend_wx_id" onchange="showFriendSelect()" style="display: none" class="form-control select2 select2-hidden-accessible" tabindex="-1" aria-hidden="true"></select>
                    </div>
                    <div id="img_area" class="col-7" style="display: none">
                        <img width='40px' height='40px' id="head_pic" src=""/><label id="wx_choose_name"></label>
                    </div>
                </div>
{#                <div class="row" style="margin-top: 10px;">#}
{#                    <div class="col-2" style="text-align: right">#}
{#                        <label>昵称<font color="red">*</font></label>#}
{#                    </div>#}
{#                    <div class="col-10">#}
{#                        <input type='text' class="form-control" id='group_wx_name' placeholder="我在本群的昵称(最长输入16个汉字)">#}
{#                    </div>#}
{#                </div>#}
                <div class="row" style="margin-top: 10px;">
                    <div class="col-2" style="text-align: right">
                        <label id ='NoticeName'>群公告</label>
                    </div>
                    <div class="col-10">
                        <textarea type='text' rows="3" class="form-control" id='groupNotice'></textarea>
                    </div>
                </div>
                <div class="row" style="margin-top: 10px;" id="friend_show">
                    <div class="col-2" style="text-align: right">
                        <label>好友添加<font color="red">*</font></label>
                        <input type='text'id='friend_list' hidden>
                    </div>
                    <div class="col-10">
                        <div class="col-2">
                            <button class="btn btn-app" data-toggle="modal" data-target="" onclick="wxFriendQuery()"><i class="fa fa-plus"></i></button>
                        </div>
                    </div>
                </div>
                <div class="row" style="margin-top: 10px;" id="friend_select">
                </div>
                <div class="row" style="margin-top: 10px;" id="friend">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" onclick='commitInfo()'>提交</button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal -->
</div>

<div class="modal fade" id="Modal_crontab" tabindex="-1" role="dialog" aria-labelledby="Modal_crontab" aria-hidden="true" style="z-index:1101">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="group_ID_C">定时群发</h4>
            </div>
            <div class="modal-body" style="height: 550px; overflow-y: auto">
                <input type='hidden' id='group_id'>
                <input type='hidden' id='flag'>
                <div class="row" style="margin-top: 10px;">
                    <div class="col-2" style="text-align: right">
                        <label>群名称<font color="red">*</font></label>
                    </div>
                    <div class="col-10">
                        <input type='text' class="form-control" id='group_name_C' placeholder="群名称(最长输入16个汉字)">
                    </div>
                </div>
                <div class="row" style="margin-top: 10px;">
                    <div class="col-2" style="text-align: right">
                        <label>主号<font color="red">*</font></label>
                    </div>
                    <div class="col-10">
                        <input type='text' class="form-control" id='group_wx_name_C' placeholder="我在本群的昵称(最长输入16个汉字)">
                        <input type='hidden' id='wx_id_C' value="">
                    </div>
                </div>
                <div class="row" style="margin-top: 10px;">
                    <div class="col-2" style="text-align: right">
                        <label>计划名称<font color="red">*</font></label>
                    </div>
                    <div class="col-10">
                        <input type='text' class="form-control" id='group_plan_name_C' placeholder="请输入计划名称">
                    </div>
                </div>
                <div class="row" style="margin-top: 10px;">
                    <div class="col-2" style="text-align: right">
                        <label>计划类型<font color="red">*</font></label>
                    </div>
                    <div class="col-10">
                       <div class="row">
                            <div class="col-2">
                                    <input id="cronType_O" name="scheduleType" type="radio" value="1" checked><span style="margin-left: 10px">一次 </span>
                            </div>
                            <div class="col-2">
                                    <input id="cronType_A" name="scheduleType" type="radio" value="2"><span style="margin-left: 10px">每天</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row" style="margin-top: 10px;">
                    <div class="col-2" style="text-align: right">
                        <label>时间计划<font color="red">*</font></label>
                    </div>
                    <div class="col-10">
                        <input class="form-control" class="Wdate"  id="scheduleTime" style="height:40px;" type="text"  placeholder="时间计划" onClick="WdatePicker({el:this,dateFmt:'yyyy-MM-dd HH:mm:ss'})">
                    </div>
                </div>

                <div class="row" style="margin-top: 10px;">
                    <div class="col-2" style="text-align: right">
                        <label>发送文本<font color="red">*</font></label>
                    </div>
                    <div class="col-10">
                         <textarea type='text' rows="3" class="form-control" id='sendText_C' placeholder="请输入发送文本"></textarea>
                    </div>
                </div>
                <div class="row" style="margin-top: 10px;">
                    <div class="col-2" style="text-align: right">
                        <label>发送图片</label>
                    </div>
                    <div class="col-8">
                        <div class="row" id="img_show">
                            <div class="col-3" id="img_upload_file">
                                <div class="file-upload-img" id="upFile">
                                    <div class="addline"></div>
                                    <div class="addline"></div>
                                </div>
                                <input class="file-button" multiple accept="image/png, image/jpeg, image/jpg," type="file" name="chatfiles" id="file_upload">
                            </div>
                        </div>
                    </div>
                </div>

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal" onclick='envClear()'>关闭</button>
                <button type="button" class="btn btn-primary" id = "scheduleCommitInfoButton" onclick='scheduleCommitInfo()'>提交</button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal -->
</div>

<div class="modal fade" id="Modal_friend" tabindex="2" role="dialog" aria-labelledby="Modal_friend" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="card task_dialog">
                <div class="card-header">
                    <h4 class="card-title" >好友查找</h4>
                </div>
                <div class="card-body" style="height: 500px; overflow: auto;">
                    <!--main-->
                    <div class="container">
                        <div class="container">
                            <div class="row clearfix">
                                <div class="input-group col-12" style="margin-bottom: 10px">
                                    <input id="wx_name_query" type="text" class="form-control" placeholder="Search">
                                    <div class="input-group-prepend">
                                        <button class="btn btn-primary" onclick="filterFriend()"><i class="fa fa-search"></i></button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row clearfix">
                            <div class="col-md-12 column">
                                <section class="content">
                                    <div class="card">
                                           <table class="table table-striped" id="friend_table"></table>
                                    </div>
                                </section>
                            </div>
                        </div>
                    </div>
                    <!--main end-->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" onclick="addFriend()">确定</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="Modal_task" tabindex="-1" role="dialog" aria-labelledby="Modal_task" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <div class="col-3"><h4 class="modal-title" id="taskTitle">任务信息</h4></div>
                <div class="col-6">
                    <input type="text" class="datepicker" placeholder="任务时间" id="task_date" readonly>
                </div>
                <div class="col-3">
                    <button class="btn btn-primary" onclick="queryGroupTask()"><i class="fa fa-search"></i> 查询 </button>
                </div>
            </div>
            <div class="modal-body" style="height: 500px; overflow: auto;">
                <table id="taskInfoTable" class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>群名称</th>
                            <th>群主</th>
                            <th>类型</th>
                            <th>开始时间</th>
                            <th>耗时(秒)</th>
                            <th>状态</th>
                            <th>出错原因</th>
                        </tr>
                    </thead>
                    <tbody id="taskInfoTableBody">
                    </tbody>
                </table>
            </div>
            <div class="modal-footer">

            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal -->
</div>

{#定时计划查询modal#}
<div class="modal fade" id="Modal_Edit" tabindex="-1" role="dialog" aria-labelledby="Modal_create1"
     aria-hidden="true" style="z-index:1100">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="scheduleGroupName"></h4>
            </div>
            <div class="card card-primary task_dialog">
                <div class="modal-body">
                    <table id="scheduleInfoTable" class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th style='text-align:center;'>计划名称</th>
                                <th style='text-align:center;'>执行时间</th>
                                <th style='text-align:center;'>期限</th>
                                <th style='text-align:center;'>创建者</th>
                                <th style='text-align:center;'>状态</th>
                                <th style='text-align:center;'>操作</th>
                            </tr>
                        </thead>
                        <tbody id="scheduleInfoTableBody">
                        </tbody >
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal" onclick='scheduleCheckClose()'>关闭</button>
{#                <button type="button" class="btn btn-primary" onclick='editMachineInfo()'>更新#}
{#                </button>#}
            </div><!-- /.modal-content -->
        </div>
    </div><!-- /.modal -->
</div>

<!-- jQuery -->
<script src="/static/plugins/jquery/jquery.js"></script>
<script src="/static/plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
<script src="/static/plugins/datatables/jquery.dataTables.js"></script>
<script src="/static/plugins/datatables/dataTables.bootstrap4.js"></script>
<script src="/static/dist/js/adminlte.min.js"></script>
<script src="/static/plugins/iCheck/icheck.min.js"></script>
<script src="/static/plugins/bootstrap/js/bootstrap-select.min.js"></script>
<script src="/static/plugins/datepicker/bootstrap-datepicker.js"></script>
<script src="/static/page.js"></script>
<script src="/static/js/jQuery/jquery.ui.widget.js"></script>
<script src="/static/js/jQuery/jquery.fileupload.js"></script>
<script src="/static/js/common.js"></script>
    <script>
        $(function () {
            $('#task_date').datepicker({ format : 'yyyy-mm-dd', autoclose : true });
            $('#task_date').datepicker('setDate', new Date());
            $('#task_date').on("changeDate", function(e) {queryGroupTask();});

            getWxId();
            queryGroupInfo(1);
        });

        function getWxId() {
            $.ajax({
                    type: "POST",
                    url: "{% url 'getWxId' %}",
                    data: {},
                    success: function (data) {
                        severcheck(data);
                        data = parseJson(data);
                        var htmlcontent = "<option>全部</option>";
                        $.each(data.data, function (key,wx_info) {
                            htmlcontent += "<option value='" + wx_info.wx_id + "' img='" + wx_info.head_picture + "'>" + wx_info.wx_name + "(" + wx_info.wx_login_id + ")" + "</option>";
                        });
                        $("#wx_id_query").empty().append(htmlcontent);
                        $("#wx_id").empty().append(htmlcontent);
                    }
                }
            );
        }

        function showSelect(){
            if($("#wx_id").val() == ""){
                $("#img_area").hide();
            }
            else{
                $("#head_pic").attr("src",$("#wx_id").find("option:selected").attr("img"));
                $("#wx_choose_name").html($("#wx_id").find("option:selected").text());
                $("#group_wx_name").val($("#wx_id").find("option:selected").text());
                $("#img_area").show();
            }
        }

        function showFriendSelect(){
            if($("#friend_wx_id").val() == ""){
                $("#img_area").hide();
            }
            else{
                $("#head_pic").attr("src",$("#friend_wx_id").find("option:selected").attr("img"));
                $("#wx_choose_name").html($("#friend_wx_id").find("option:selected").text());
                $("#group_wx_name").val($("#friend_wx_id").find("option:selected").text());
                $("#img_area").show();
            }
        }

        function queryGroupTask(){
            var task_date = $("#task_date").val();
            $.ajax({
                    type: "POST",
                    url: "{% url 'getGroupTaskInfo' %}",
                    data: { "task_date": task_date },
                    success: function (res) {
                        severcheck(res);
                        res = parseJson(res);
                        $("#taskInfoTableBody").empty();
                        var list = res.task_list;
                        var temp = "";
                        if (list != null && list.length > 0) {
                            for (var i = 0; i < list.length; i++) {
                                var task = list[i];
                                var seconds="0";
                                if(!task.seconds){
                                    seconds="0";
                                }
                                temp += "<tr>";
                                temp += "<td style='text-align:center;'><span class='js-title' title='"+task.groupName+"' style='display:inline-block;width:100px;overflow: hidden;white-space: nowrap;text-overflow: ellipsis;'>" + task.groupName + "</span></td>";
                                temp += "<td style='text-align:center;'><span class='js-title' title='"+task.mainWxName+"' style='display:inline-block;width:80px;overflow: hidden;white-space: nowrap;text-overflow: ellipsis;'>" + task.mainWxName + "</span></td>";
                                temp += "<td style='text-align:center;'><span style='display:inline-block;width:60px;'>" + task.actionType + "</span></td>";
                                temp += "<td style='text-align:center;'><span class='js-title' title='"+task.startTime+"' style='display:inline-block;width:80px;overflow: hidden;white-space: nowrap;text-overflow: ellipsis;'>" + task.startTime + "</td>";
                                temp += "<td style='text-align:center;'><span style='display:inline-block;width:60px;'>" + task.seconds + "</span></td>";
                                if (task.status == 0){
                                    temp += "<td style='text-align:center;'><span class='badge bg-warning'>初始化</span></td>";
                                    temp += "<td style='text-align:center;'></td>";
                                } else if ( task.status == 1){
                                    temp += "<td style='text-align:center;'><span class='badge bg-primary'>下发中</span></td>";
                                    temp += "<td style='text-align:center;'></td>";
                                } else if ( task.status == 2)
                                {
                                    temp += "<td style='text-align:center;'><span class='badge bg-warning'>执行中</span></td>";
                                    temp += "<td style='text-align:center;'></td>";
                                } else if ( task.status == 4)
                                {
                                    temp += "<td style='text-align:center;'><span class='badge bg-success'>完成</span></td>";
                                    temp += "<td style='text-align:center;'></td>";
                                } else if ( task.status == 3)
                                {
                                    temp += "<td style='text-align:center;'><span class='badge bg-danger'>失败</span></td>";
                                    temp += "<td style='text-align:center;'><span class='js-title' title='"+task.remark+"' style='display:inline-block;width:150px;overflow: hidden;white-space: nowrap;text-overflow: ellipsis;'>" + task.remark + "</span></td>";
                                } else if ( task.status == 5)
                                {
                                    temp += "<td style='text-align:center;'><span class='badge bg-warning'>暂停</span></td>";
                                    temp += "<td style='text-align:center;'></td>";
                                } else if ( task.status == 6)
                                {
                                    temp += "<td style='text-align:center;'><span class='badge bg-warning'>失败(微信登出)</span></td>";
                                    temp += "<td style='text-align:center;'><span class='js-title' title='"+task.remark+"' style='display:inline-block;width:150px;overflow: hidden;white-space: nowrap;text-overflow: ellipsis;'>" + task.remark + "</span></td>";
                                } else {
                                    temp += "<td style='text-align:center;'><span class='badge bg-warning'>未知</span></td>";
                                    temp += "<td style='text-align:center;'><span class='js-title' title='"+task.remark+"' style='display:inline-block;width:150px;overflow: hidden;white-space: nowrap;text-overflow: ellipsis;'>" + task.remark + "</span></td>";
                                }

                                temp += "</tr>";
                            }
                            $("#taskInfoTableBody").append(temp);
                        }
                    },
                    error: function () {}
                }
            );

            $("#Modal_task").modal("show");
        }

        function queryGroupInfo(pageIndex) {
            var pageSize = $("#pageSize_value").val();
            pageSize = filterNull(pageSize, 5);
            $.ajax({
                    type: "POST",
                    url: "{% url 'groupInfo' %}",
                    data: {
                        "pageIndex": pageIndex,
                        "pageSize": pageSize,
                        "group_name": $("#group_name_query").val(),
                        "wx_id": ($("#wx_id_query").val()=='全部')?'':$("#wx_id_query").val()
                    },
                    success: function (res) {
                        severcheck(res);
                        res = parseJson(res);
                        $("#_tableId").empty();
                        var list = res.pageList;
                        var count = res.count;
                        var temp = "";
                        if (list != null && list.length > 0) {
                            for (var i = 0; i < list.length; i++) {
                                var group_id = list[i][0];   //群号
                                var group_name = list[i][1]; //群名称
                                var wx_main_id = list[i][2]; //微信主号
                                var wx_main_name = list[i][3]; //微信主号名称
                                var group_wx_name = list[i][11];//群主名称
                                var group_wx_id = list[i][10];//群主编号
                                //if(list[i][4] != null && list[i][4] != ''){//群主名称
                                    //group_wx_name =  list[i][4];
                                //}
                                var description= list[i][5];
                                if(description == null){
                                    description = "";
                                }
                                var notice = list[i][6];
                                if(notice == null){
                                    notice = "";
                                }
                                var checkValue=group_id+","+group_name+","+group_wx_id+","+group_wx_name+","+description+","+notice.replace(/[\r\n]/g," ")+","+list[i][8]+","+wx_main_id+","+wx_main_name;
                                temp += "<tr><td  style='text-align:center;'><input type='radio' name='machineItem' value='" + checkValue + "'/></td>"; //群ID
                                temp += "<td style='text-align:center;'><span class='js-title' title='"+list[i][1]+"' style='display:inline-block;width:150px;overflow: hidden;white-space: nowrap;text-overflow: ellipsis;'>" + list[i][1] + "</span></td>";//群名称
                                temp += "<td style='text-align:center;'>" + wx_main_name + "</td>";//主号昵称
                                temp += "<td style='text-align:center;'>" + group_wx_name + "</td>";//群主昵称
                                temp += "<td style='text-align:center;'><span class='js-title' title='"+notice+"' style='display:inline-block;width:300px;overflow: hidden;white-space: nowrap;text-overflow: ellipsis;'>" + notice + "</span></td>";//群公告
                                temp += "<td style='text-align:center;'>" + list[i][7] + "</td>";//群人数
                                temp += "<td style='text-align:center;'>" + "<a style='cursor:pointer;margin-right: 10px;'"  +
                                        "title='定时计划' onclick=\"scheduleCheck(\'" + checkValue  + "\');\">" ;
                                if(list[i][9] >= 1){
                                    temp += "<i class='fa fa-info-circle' data-toggle='modal' ></i></a>"
                                }
                                temp += "</td>";//查看计划列表
                                temp += "</tr>";
                            }
                            $("#_tableId").append(temp);
                        }
                        $(("[type='radio']")).iCheck({
                            checkboxClass: 'icheckbox_square-blue',
                            radioClass: 'iradio_square-blue'
                        });

                        //全选
                        $('#allItem').on('ifChecked', function (event) {
                            $("input").iCheck('check');
                        });
                        //反选
                        $('#allItem').on('ifUnchecked', function (event) {
                            $("input").iCheck('uncheck');
                        });

                        var pages = Math.ceil(count / pageSize);
                        page = {'total': count, 'pageNum': pageIndex, 'pages': pages};
                        setPage(page, "queryGroupInfo", "show");
                    },
                    error: function () {}
                }
            );
        }

        function filterNull(_val, replaceVal) {
            if (replaceVal == null || replaceVal == undefined)
                replaceVal = "&nbsp;";
            if (_val == null || _val == undefined || _val == "")
                _val = replaceVal;
            return _val;
        }

        function commitInfo() {
            var group_name = $("#group_name").val();
            var wx_id = $("#wx_id").val();
            var groupNotice = $("#groupNotice").val();
            var friend_list = "";
            var group_wx_name = $("#group_wx_name").val();

            $('#friend').find('.img_show_div').each( function(index, obj) {
                    if(friend_list==""){
                        friend_list=$(obj).attr("data");
                    }
                    else{
                        friend_list=friend_list+"#"+$(obj).attr("data");
                    }
                }
            );

            if(group_name == ""){
                alert("请输入群名称");
                return false;
            }
            if(group_name.length > 32){
                alert("群名称超过16个汉字的长度");
                return false;
            }
            if(groupNotice.length > 4000){
                alert("群公告超过2000个汉字的长度");
                return false;
            }

            if(wx_id == "" || !wx_id){
                alert("请选择群主");
                return false;
            }


            if(""==friend_list && ($("#flag").val() == "insert" || $("#flag").val() == "add_member" || $("#flag").val() == "del_member")){
                alert("请选择好友");
                return false;
            }

            var friend = $("#friend").find("div");

            if (friend.length < 2 && $("#flag").val() == "insert") {
                alert("除群主外，请至少添加2名群好友");
                return false;
            }

            if($("#flag").val() == "del_member"){
                var friend_select = $("#friend_select").find("div");
                if (friend_select.length < 3 ) {
                    alert("至少保留2名成员");
                    return false;
                }
            }


            $.ajax({
                type: "POST",
                url: "{% url 'saveGroupInfo' %}",
                data: {
                    "flag": $("#flag").val(),
                    "group_name": group_name,
                    "wx_id": wx_id,
                    "group_wx_name" : group_wx_name,
                    "groupUsage": "",
                    "groupNotice": groupNotice,
                    "friend_list": friend_list,
                    "group_id":$("#group_id").val(),
                    "friend_wx_id" : $("#friend_wx_id").val()
                },
                success: function (res) {
                    severcheck(res);
                    res = parseJson(res);
                    if (res["status"] == 200) {
                        alert("任务提交成功！");
                        $("#Modal_create").modal("hide");
                        queryGroupInfo(1);
                        queryGroupTask();
                        return;
                    }else{
                        alert(res["msg"]);
                    }
                }
            });
        }

        function filterFriend(){
            var wx_name = $("#wx_name_query").val();
            $("[name='friendtr']").each(function(){
                if("" == wx_name){
                    $(this).show();
                }
                else if($(this).attr("data").indexOf(wx_name) != -1){
                    $(this).show();
                }
                else{
                    $(this).hide();
                }
            });
        }
        function wxFriendQuery() {
            var wx_id = $("#wx_id").val();
            if(wx_id == ""){
                alert("请先选择群主");
                return false;
            }
            $.ajax({
                url: "{% url 'getWxFriend' %}",
                type: "GET",
                data: {"wx_id":wx_id},
                success: function (data) {
                    severcheck(data);
                    data = parseJson(data);
                    data = data.data;
                    if (data) {
                        var tempHtml = "<thead><tr>";
                        tempHtml += "<th><input type='checkbox' id='friend_check' ></th>";
                        tempHtml += "<th>头像</th><th>微信号</th><th>昵称</th></tr><thead><tbody>";
                        $.each(data,function (key, wx_info) {
                                var checkAccountValue = wx_info["head_picture"] + ',' + wx_info["wx_id"] + ','
                                    + wx_info["wx_name"] ;
                                var checked = "";
                                $('.img_show_div').each( function(index, obj) {
                                        if( checkAccountValue.trim() == $(obj).attr("data").trim())
                                        {
                                            checked="checked";
                                        }
                                    }
                                );

                                if(checked != "checked" && wx_info["wx_id"]!=wx_id) {//已选择的跳过
                                    tempHtml += '<tr name="friendtr" data="' + checkAccountValue + '"><td><input type="checkbox"  name="friend_check" value="' + checkAccountValue + '"/></td>';
                                    tempHtml += "<td><img width='40px' height='40px' src='" + wx_info["head_picture"] + "' class='img-circle' /></td>";
                                    tempHtml += "<td> <span title='" + wx_info["wx_id"] + "' style='display:inline-block;width:110px;overflow: hidden;white-space: nowrap;text-overflow: ellipsis;'>" + wx_info["wx_id"] + "</td>";
                                    tempHtml += "<td>" + wx_info["wx_name"] + "</td>";
                                    tempHtml += "</tr>";
                                }
                        });
                        tempHtml += "</tbody>";
                        $("#friend_table").html(tempHtml);

                        $("#Modal_friend").modal("show");

                        $(("[type='checkbox']")).iCheck({
                            checkboxClass : 'icheckbox_square-blue',
                            radioClass: 'iradio_square-blue'
                        });

                        //全选
                        $("#friend_check").on('ifChecked', function(event){
                            $('input[name="friend_check"]').each( function(index, obj){
                                if ($(obj).parent().parent().parent().attr("style")!="display: none;")
                                {
                                    $(obj).iCheck('check');
                                }
                            })

                        });
                        //反选
                        $("#friend_check").on('ifUnchecked', function(event){
                             $('input[name="friend_check"]').each( function(index, obj){
                                if ($(obj).parent().parent().parent().attr("style")!="display: none;")
                                {
                                    $(obj).iCheck('uncheck');
                                }
                            })
                        });
                    }
                }
            });
        }

        function addFriend(){
            $('input[name="friend_check"]:checked').each(function () {
                var imgurl=$(this).val().split(",")[0];
                var htmlcontent="<div class='col-1 img_show_div' style='text-align: center' name='imgvalue' data='"+$(this).val()+"'><img style='width:40px; height:40px; border: 1px solid #ddd;' src='"+imgurl+"'><i class='fa fa-trash-o' onclick='$(this).parent().remove();'></i></div>";
                $("#friend").append(htmlcontent);
            });
            $("#Modal_friend").modal("hide");
        }

        function editGroup(flag){
            var checkValue=$('input[name="machineItem"]:checked').val();
            var checkStatus = 1
            if (flag != "insert") {
                if(!checkValue ){
                    alert("请选择一条记录");
                    return false;
                } else {
                    var checkValuesTmp=checkValue.split(",");
                    $.ajax({
                        url: "{% url 'authCheck' %}",
                        type: "GET",
                        async: false,
                        data: {"groupId": checkValuesTmp[0]},
                        success: function (data) {
                            severcheck(data);
                            data = parseJson(data);
                            if (data['authCheckStatus'] == 0) {
                                alert('当前选择群，无群主执行权限');
                                checkStatus = -1
                            }
                        }
                    })
                }
            }

            if(checkStatus == -1){
                return false
            }
            $("#friend").html("");
            $("#friend_select").html("");
            $("#wx_id").show();
            $("#friend_wx_id").hide();
            if("insert" == flag)
            {
                $("#group_id").val("");
                $("#group_name").val("");
                $("#group_wx_name").val("");
                $("#wx_id").val("");
                $("#groupNotice").val("");
                $("#group_name").removeAttr("disabled");
                $("#group_wx_name").removeAttr("disabled");
                $("#wx_id").removeAttr("disabled");
                $("#groupNotice").removeAttr("disabled");
                $("#friend_show").show();
                $("#Modal_create").modal("show");
                $("#head_pic").attr("hidden", "");
                $("#head_pic").attr("src", "");
                $("#wx_choose_name").html("");
                return true;
            }

            var checkValues=checkValue.split(",");
            $("#group_id").val(checkValues[0]);
            $("#group_name").val(checkValues[1]);
            $("#wx_id").val(checkValues[2]);
            $("#group_wx_name").val(checkValues[3]);
            $("#groupNotice").val(checkValues[5]);
            if(checkValues[6] == 2){
                alert("系统繁忙，请稍后重试！");
                return false;
            }

            $("#group_name").attr("disabled","disabled");
            $("#group_wx_name").attr("disabled","disabled");
            $("#wx_id").attr("disabled","disabled");
            $("#groupNotice").attr("disabled","disabled");
            $("#friend_show").hide();
            if("delete" == flag){
                $("#friend_show").hide();
                //添加头像
                $("#head_pic").attr("src", $("#wx_id").find("option:selected").attr("img"));
                $("#head_pic").removeAttr("hidden");
                $("#wx_choose_name").html($("#wx_id").find("option:selected").text());
                $("#group_wx_name").val($("#wx_id").find("option:selected").text());
                $("#img_area").show();
            }
            else if("notice" == flag){
                $("#groupNotice").removeAttr("disabled");
            }
            else if("modify_name" == flag){
                $("#group_wx_name").removeAttr("disabled");
            }
            else if("crontab" == flag){
                $("#NoticeName").hide();
                $("#groupNotice").hide();

            }
            else{
                if("add_member" == flag){
                    $("#friend_show").show();
                }
                else if("update_wx_id" == flag){
                    $("#wx_id").removeAttr("disabled");
                    $("#wx_id").hide();
                    $("#friend_wx_id").show();
                }
                $.ajax({
                    url: "{% url 'getMember' %}",
                    type: "GET",
                    data: {"group_id": checkValues[0], "wx_main_id": checkValues[2]},
                    success: function (data) {
                        severcheck(data);
                        data = parseJson(data);
                        var content="";
                        $("#friend_select").append("<div class='col-12' >已有成员：</div>");
                        if("del_member" == flag){
                            $("#friend").append("<div class='col-12' >需要删除的成员：</div>");
                        }
                        else{
                            $("#friend").append("<div class='col-12' >需要添加的成员：</div>");
                        }

                        $.each(data.data ,function (key,wx_info) {
                            var imgurl=wx_info["head_picture"];
                            var dataValue=wx_info["head_picture"]+","+wx_info["wx_id"]+","+wx_info["wx_name"];
                            var htmlcontent="";
                            var delHtml="";
                            if("del_member" == flag){
                                delHtml="<i class='fa fa-trash-o' onclick='deleteMemeber()'></i>";
                            }
                            if("" == wx_info["head_picture"]){
                                htmlcontent="<div class='col-1 img_show_div' style='text-align: center;margin-bottom: 5px;' name='imgvalue' data='"+dataValue+"'>"+wx_info["wx_name"]+ delHtml +"</div>";
                            }else{
                                htmlcontent="<div class='col-1 img_show_div' style='text-align: center;margin-bottom: 5px;' name='imgvalue' data='"+dataValue+"'><img style='width:40px; height:40px; border: 1px solid #ddd;' src='"+imgurl+"' >"+ delHtml +"</div>";
                            }
                            if(wx_info["wx_id"] != $("#wx_id").val()){
                                $("#friend_select").append(htmlcontent);
                            }

                            if(checkValues[2] != wx_info["wx_id"]){
                                content+="<option value='"+wx_info["wx_id"]+"' img='"+wx_info["head_picture"]+"' >" +wx_info["wx_name"]+"</option>";
                            }
                        });
                        $("#friend_wx_id").empty().append(content);
                    }
                });
            }

            $("#Modal_create").modal("show");
        }

        function deleteMemeber(){
            if($(event.target.parentElement.parentElement).attr("id") == "friend_select" ){
                $('#friend').append($(event.target.parentElement).prop("outerHTML"));
                $(event.target.parentElement).remove();
            }
            else{
                $('#friend_select').append($(event.target.parentElement).prop("outerHTML"));
                $(event.target.parentElement).remove();
            }

        }
        function crontab() {
            var checkValue=$('input[name="machineItem"]:checked').val();
            if(!checkValue){
                alert("请选择一条记录");
                return false;
            }
            var checkValues=checkValue.split(",");
            $("#group_ID_C").val(checkValues[0]);
            $("#group_name_C").val(checkValues[1]);
            $("#wx_id_C").val(checkValues[7]);//主号
            $("#group_wx_name_C").val(checkValues[8]);//主号名称
            $("#group_plan_name_C").val("");
            $("#scheduleTime").val("");
            $("#sendText_C").val("");
            $('#img_upload_file').show();
            $("#group_name_C").attr("disabled","disabled");
            $("#group_wx_name_C").attr("disabled","disabled");
            $("#Modal_crontab").modal("show");
        }

        (function(){
            $('#file_upload').fileupload({
              url: "{% url 'fileupload' %}",

              change: function(e, data) {//这个是选择文件的回调函数
                  if(data.files.length > 9){//这里是判断选择文件的个数,根据实际情况设置
                    alert("最多只能选择9张图片");
                    return false;
                }
                for(var i=0;i < data.files.length;i++) {
                    if(data.files[i].size > 1024*1024*5)
                    {
                        alert("图片"+data.files[i].name+"大于5MB");
                        return false;
                    }
                }
                data.formData = { wx_id: $("#wx_id_C").val() };
              },
              done: function (e, data) {

                  if($('.img_show_div').length >= 9){
                      $('#img_upload_file').hide();
                      return false;
                  }
                  if(data  && data.result){
                      data = JSON.parse(data.result);
                      var imgurl = data["content"]
                      var imghtml="<div class='col-4 img_show_div'  name='imgvalueShow' data='"+data["filename"]+"|"+imgurl+"'><img src='"+imgurl+"'><i class='fa fa-trash-o' onclick='$(this).parent().remove();$(\"#img_upload_file\").show();'></i></div>";
                      $("#img_show").prepend(imghtml);
                      if($('.img_show_div').length == 9){
                          $('#img_upload_file').hide();
                      }
                  }
              },
              fail: function () {
                alert('上传出错！');
              }
            });
         })();

        function scheduleCheck(groupInfo) {
            var CheckStatus = 1;
            var dataListNum = 0;
            groupList = groupInfo.split(',');
            groupId = groupList[0];
            groupName = groupList[1];
            wx_id = groupList[7];
            $("#scheduleGroupName").text(groupName);
            $.ajax({
                    url: "{% url 'groupScheduleCheck' %}",
                    type: "GET",
                    async: false,
                    data: {"groupId": groupId, "wx_id": wx_id},
                    success: function (data) {
                        severcheck(data);
                        data = parseJson(data);
                        var dataList = data.dataList;
                        dataListNum =dataList.length;
                        var CheckStatus = data.CheckStatus;
                        var htmlTmp = "";
                        $("#scheduleInfoTableBody").html("");
                        if (dataList != null && dataList.length > 0) {
                            for (var i = 0; i < dataList.length; i++) {
                                var data = dataList[i];
                                htmlTmp += "<tr id =\"" + data.taskMain +  "_line\">";
                                htmlTmp += "<td style='text-align:center;'>" + data.planName + "</td>";// 计划名称
                                htmlTmp += "<td style='text-align:center;'>" + data.actionTime + "</td>";// 执行时间
                                htmlTmp += "<td style='text-align:center;'>" + data.deadLine + "</td>";// 期限
                                htmlTmp += "<td style='text-align:center;'>" + data.creator + "</td>";// 创建者
                                if (data.status == 1){
                                    htmlTmp += "<td><span class=\"badge bg-success\" id = \'" + data.taskMain + "_status\'>有效</span></td>"
                                }else {
                                    htmlTmp += "<td><span class=\"badge bg-warning\" id = \'" + data.taskMain + "_status\'>失效</span></td>"
                                }
                                htmlTmp += "<td style='text-align:center;'>" +
                                            "<a style='cursor:pointer;margin-right: 10px;'"  + "title='计划信息查看' onclick=\"scheduleByTaskSeqMian(\'"+ data.taskMain + "\');\">" +
                                            "<i class='fa fa-search' data-toggle='modal' ></i></a>" +
                                            "<a style='cursor:pointer;margin-right: 10px;'"  + "title='失效计划' onclick=\"scheduleTaskAction(" +  data.taskMain +  ",\'0\');\">" +
                                            "<i class='fa fa-stop' data-toggle='modal' ></i></a>" +
                                            "<a style='cursor:pointer;margin-right: 10px;'"  + "title='重启计划' onclick=\"scheduleTaskAction(" +  data.taskMain +  ",\'1\');\">" +
                                            "<i class='fa fa-refresh' data-toggle='modal' ></i></a>" +
                                            "</td>";//查看计划列表
                                htmlTmp += "</tr>";
                            }
                            $("#scheduleInfoTableBody").append(htmlTmp);
                        }
                    }
                });
            if (CheckStatus == 1){
                if (dataListNum == 0){
                    alert("该群无相关定时任务信息")
                }else{
                    $("#Modal_Edit").modal("show");
                }
            }else {
                alert("查询出错，请联管理人员")
            }

        }

        function scheduleCommitInfo() {
            scheduleTime = $("#scheduleTime").val();
            var scheduleTimestamp = new Date(scheduleTime).getTime();
            var timestampNow = Date.parse(new Date());
            var scheduleType = $("input[name='scheduleType']:checked").val();
            var scheduleText = $("#sendText_C").val();
            var planName = $("#group_plan_name_C").val();
            if (planName == undefined || planName == ""){
                alert("请输入计划名称");
                return false;
            } else if (scheduleTime == ""){
                alert("计划时间不能为空");
                return false;
            } else if ( scheduleTimestamp <= timestampNow){
                alert("计划时间需大于当前时间");
                return false;
            }
            if (scheduleText == "" && $('.img_show_div').length == 0){
                alert("文本或图片不能皆为空");
                return false;
            }
            schedulePicName = ""
            if ($('.img_show_div[name="imgvalueShow"]').length > 0){
                $('.img_show_div[name="imgvalueShow"]').each(
                        function(index, obj) {
                            schedulePicName += $(obj).attr("data") + ';'
                        }
                    );
            }
            groupId = $("#group_ID_C").val();
            $.ajax({
                    url: "{% url 'groupSchedule' %}",
                    type: "GET",
                    async: false,
                    data: {"planName":planName,
                            "groupId": groupId,
                            "scheduleTime" : scheduleTime,
                            "scheduleType" : scheduleType,
                            "scheduleText" : scheduleText,
                            "schedulePicName" : schedulePicName,
                            "wx_id" : $("#wx_id_C").val()
                        },
                    success: function (data) {
                        severcheck(data);
                        data = parseJson(data);
                        if (data['retStatus'] == 1) {
                            alert('任务下发成功');
                        }else if (data['retStatus'] == -1){
                            alert('任务下发失败');
                        }else if (data['retStatus'] == -2){
                            alert('任务下发失败，无有效主号可执行');
                        }
                    }
                });
            $("#Modal_crontab").modal("hide");
            $('#scheduleCommitInfoButton').removeAttr('disabled');
            $("*[name='imgvalueShow']").remove();

        }
        function scheduleTaskAction(taskSeqMain,type) {
            var r=confirm("确认执行操作");
            if (r==true){
                $.ajax({
                        url: "{% url 'scheduleTaskAction' %}",
                        type: "GET",
                        data: {"taskSeqMain": taskSeqMain,
                                "type": type},
                        success: function (data) {
                            severcheck(data);
                            data = parseJson(data);
                            if (data['actionStatus'] == 1) {
                                alert('执行成功');
                                taskSeqStausId = taskSeqMain + "_status";
                                if (type == "1"){
                                    $("#" +  taskSeqStausId).text('有效');
                                    $("#" +  taskSeqStausId).attr("class","badge bg-success");
                                } else {
                                    $("#" +  taskSeqStausId).text('失效');
                                    $("#" +  taskSeqStausId).attr("class","badge bg-warning");
                                }
                            }else {
                                alert('执行失败');
                            }
                        }
                    })
            }
        }
        function scheduleCheckClose() {
            $("#scheduleInfoTableBody").empty()
        }
        function scheduleByTaskSeqMian(taskMain) {

            $.ajax({
                url: "{% url 'scheduleByTaskSeqMian' %}",
                type: "GET",
                async: false,
                data: {"taskMain": taskMain },
                success: function (data) {
                    severcheck(data);
                    data = parseJson(data);
                    if (data['actionStatus'] == 1) {
                        var groupNameByTaskMain = data['groupName'];
                        $("#group_name_C").val(groupNameByTaskMain);

                        var wxNameByTaskMain = data['wxName'];
                        $("#group_wx_name_C").val(wxNameByTaskMain);

                        var planNameeByTaskMain = data['planName'];
                        $("#group_plan_name_C").val(planNameeByTaskMain);

                        var planTypeByTaskMain = data['planType'];
                        if (planTypeByTaskMain == "1"){
                            $("#cronType_O").iCheck('check');
                        }else if (planTypeByTaskMain == "2"){
                            $("#cronType_A").iCheck('check');
                        }

                        var actionTimeByTaskMain = data['actionTime'];
                        $("#scheduleTime").val(actionTimeByTaskMain);

                        var sendTextByTaskMain = data['sendText'];
                        $("#sendText_C").val(sendTextByTaskMain);

                        var sendPicByTaskMain = data['sendPic'];
                        $('#img_upload_file').hide();
                        imghtmlTmp = "";
                        $("#img_show").empty();
                        for (var i = 0; i < sendPicByTaskMain.length; i++){
                            imgurl = sendPicByTaskMain[i]
                            imghtml="<div class='col-4 img_show_div' name='imgvalueShow' data='"+sendPicByTaskMain[i]+"'><img src='"+imgurl+"'></div>";
                            $("#img_show").prepend(imghtml);
                        }
                    }else {
                        alert('执行失败');
                    }
                }
            });
            $('#scheduleCommitInfoButton').attr('disabled',"true");
            $("#Modal_crontab").modal("show");
        }
        function envClear() {
            $('#scheduleCommitInfoButton').removeAttr('disabled');
            $("*[name='imgvalueShow']").remove();
        }
</script>
</body>
</html>