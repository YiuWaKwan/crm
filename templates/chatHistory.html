<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
 <!-- Tell the browser to be responsive to screen width -->
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="/static/plugins/font-awesome/css/font-awesome.min.css">
  <!-- Ionicons -->
  <link rel="stylesheet" href="/static/dist/css/ionicons.min.css">
  <!-- DataTables -->
  <link rel="stylesheet" href="/static/plugins/datatables/dataTables.bootstrap4.css">


  <link rel="stylesheet" href="/static/plugins/iCheck/all.css">

 <!--  <link rel="stylesheet" href="/static/dist/css/bootstrap-tagsinput.css">-->

  <!-- Select2 -->
  <link rel="stylesheet" href="/static/plugins/select2/select2.min.css">

<link rel="stylesheet" href="/static/tooltipster/tooltipster.bundle.min.css" />
 <!-- 图片放大css-->
<link rel="stylesheet" href="/static/css/imgSize.css" />
  <!-- Theme style 放最下面，否则有些插件显示样式会不统一-->
  <link rel="stylesheet" href="/static/dist/css/adminlte.min.css">
    <style type="text/css">
.select2-selection__clear{
    display: none;
}

</style>
    <style type="text/css">
    .select2-container--default  .select2-selection--single{
      height:40px;
      line-height: 40px;
      width: 190px;
    }
</style>
</head>


<body class="hold-transition sidebar-mini">
<section class="content">
    <div class="row" style="margin-top:20px;margin-left:1px;">
      <div class="input-group-append col-2">
        <span class="input-group-text"><i class="fa fa-group  fa-lg"></i></span>
        <select id="wxMainIdSearch" class="form-control select2 select2-hidden-accessible"  tabindex="-1" aria-hidden="true">
            <option selected="selected"  value="" >主号列表</option>
            {% for  key, value in wxMainList %}
            <option value={{value}}>{{key}}</option>
            {% endfor %}
        </select>
      </div>

      <div class="input-group col-2">
          <div class="input-group-prepend">
            <span class="input-group-text"><i class="fa fa-book  fa-lg"></i></span>
          </div>
          <select id="isGroup" class="form-control" style="height:40px;">
               <option selected="selected"  value="" >是否群聊</option>
              <option   value="1" >群</option>
              <option   value="0" >好友</option>
               </select>
      </div>
      <div class="input-group col-2">
          <div class="input-group-prepend">
            <span class="input-group-text"><i class="fa fa-weixin  fa-lg"></i></span>
          </div>
          <input id="wxIdSearch" type="text" class="form-control" placeholder="好友号、群号">
      </div>
      <div class="input-group col-2">
          <div class="input-group-prepend">
            <span class="input-group-text"><i class="fa fa-book  fa-lg"></i></span>
          </div>
          <input id="friendNameSearch" type="text" class="form-control" placeholder="好友或群昵称">
      </div>
    <div class="input-group col-4">
        <div class="col-1"> <button class="btn btn-primary" onclick="init(1)"><i class="fa fa-search"></i> 查询好友(群)</button></div>
    </div>

    </div>
    <div class="row" style="margin-top:20px;margin-left:1px;">
        &nbsp;&nbsp; <input class="Wdate " id="startDate" style="height:40px;" type="text"  placeholder="开始时间" onClick="WdatePicker({el:this,dateFmt:'yyyy-MM-dd HH:mm:ss',maxDate:'#F{$dp.$D(\'endDate\')}'})">
         &nbsp;&nbsp;&nbsp;&nbsp;<input class="Wdate " id="endDate" style="height:40px;" type="text"  placeholder="结束时间" onClick="WdatePicker({el:this,dateFmt:'yyyy-MM-dd HH:mm:ss',minDate:'#F{$dp.$D(\'startDate\')}'})">
     &nbsp;&nbsp;<div class="col-1"> <button class="btn btn-primary" onclick="toExportHistory()"><i class="fa fa-save"></i> 导出</button></div>

    </div>


</section>
<!-- Main content -->
 <section class="content">
<div class="col-md-12" style="margin-top:20px;">
	<div class="card">
        <div class="card-body p-0">
           <table class="table table-striped">
               <thead>
                <tr>
                  <th><input type="checkbox" id="allItem" name="allItem" value=""/></th>
                   <th style='text-align:center;'>主号</th>
                  <th style='text-align:center;'>好友号</th>
				  <th style='text-align:center;'>好友昵称</th>
				  <th style='text-align:center;'>最近联系时间</th>
				  <th style='text-align:center;'>最近聊天消息</th>
                </tr>
                </thead>
              <tbody id="tableBody">

             </tbody>
           </table>

         </div><!-- /.card-body -->
    </div>
    <div id="example2_wrapper" class="dataTables_wrapper container-fluid dt-bootstrap4">
            <div class="row">
                <div class="col-2">
                    <div class="dataTables_info" id="userListTable_info" role="status" aria-live="polite"></div>
                </div>
                <div class="col-1">
                    <div class="dataTables_info" id="div_pageSize" role="status" aria-live="polite"></div>
                </div>
                <div class="col-2">
                    <div class="dataTables_info input-group" id="div_button" role="status" aria-live="polite"></div>
                </div>
                <div class="col-7" style="margin-top: 8px;">
                    <div class="dataTables_paginate" id="userListTable_paginate">
                    <ul class="pagination" id="page"></ul>
                    </div>
                </div>
            </div>
     </div>
</div>
 </section>


</body>
<!-- ./wrapper -->
<!-- jQuery -->
<script src="/static/plugins/jquery/jquery.min.js"></script>
<!-- Bootstrap 4 -->
<script src="/static/plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
<!-- DataTables -->
<script src="/static/plugins/datatables/jquery.dataTables.js"></script>
<script src="/static/plugins/datatables/dataTables.bootstrap4.js"></script>
<!-- SlimScroll -->
<script src="/static/plugins/slimScroll/jquery.slimscroll.min.js"></script>
<!-- FastClick -->
<script src="/static/plugins/fastclick/fastclick.js"></script>
<!-- AdminLTE App -->
<script src="/static/dist/js/adminlte.min.js"></script>
<!-- AdminLTE for demo purposes -->
<script src="/static/dist/js/demo.js"></script>
<script src="/static/plugins/iCheck/icheck.min.js"></script>
<!-- page script -->
<script src="/static/page.js"></script>
<!--<script src="/static/dist/js/bootstrap-tagsinput.js"></script>-->
<script src="/static/js/common.js"></script>
<!-- Select2 -->
<script src="/static/plugins/select2/select2.full.min.js"></script>

<script type="text/javascript" src="/static/tooltipster/tooltipster.bundle.min.js"></script>

<script src="/static/plugins/jquery/jquery.cookie.js"></script>
<script src="/static/layer/layer.js"></script>
 <script src="/static/plugins/My97DatePicker/WdatePicker.js"></script>
<script>
    $(function () {
         //init(1);
         //初始化select2
         $('.select2').select2({
              allowClear: true, //是否允许清空选中
         });

           $(("[type='checkbox']")).iCheck({
                checkboxClass : 'icheckbox_square-blue',
                radioClass: 'iradio_square-blue'
            });
      }

    );

    function init(pageIndex){
        var pageSize = $("#pageSize_value").val();
        pageSize=filterNull(pageSize,5);
        var wxMainIdVal=$("#wxMainIdSearch option:selected").val();
        if(!wxMainIdVal){
            alert("请先选择主号");
            return;
        }

        $.ajax({
        type: 'get',
        url: '/WXCRM/chatHistoryData',
        data: {"type":"getFriendList",
                "pageIndex": pageIndex,
                "pageSize": pageSize,
                "wxMainIdSearch":wxMainIdVal,
                "wxIdSearch":$("#wxIdSearch").val(),
                "isGroup":$("#isGroup").val(),
               // "startDate":$("#startDate").val(),
                //"endDate":$("#endDate").val(),
                "friendNameSearch":$("#friendNameSearch").val()
        },
        success: function (res) {
            severcheck(res);
            res = parseJson(res);
            var list = res.pageList;
            var count=res.count;
            var tableHead = "", html = "",temp="";
            $("#tableBody").empty();
            if(list!=null&&list.length>0) {
                for (var i = 0; i < list.length; i++) {
                        temp += "<tr id='"+list[i][1]+"'><td ><input type='checkbox' class='minimal' name='wxItem'   id='wxItem' value='"+list[i][1]+"'/></td>";

                        var lastChatTime=filterNull(list[i][3],"");
                        if(lastChatTime!=""){
                            lastChatTime=new Date(lastChatTime).format("yyyy-MM-dd");
                        }
                        temp += "<td style='text-align:center;'>" + list[i][0] + "</td>";//主号
                        temp += "<td style='text-align:center;'>" + list[i][1] + "</td>";//好友号
                        temp += "<td style='text-align:center;'>" + list[i][2] + "</td>";//好友昵称
                        temp += "<td style='text-align:center;'><span class='js-title' title='"+list[i][3]+"' style='display:inline-block;width:100px;overflow: hidden;white-space: nowrap;text-overflow: ellipsis;'>"+ lastChatTime+"</span></td>";//最近联系时间
                        temp += "<td style='text-align:center;'><span class='js-title' title='"+list[i][4]+"' style='display:inline-block;width:100px;overflow: hidden;white-space: nowrap;text-overflow: ellipsis;'>"+ list[i][4]+"</span></td>";//最近联系内容
                        temp +=  "</tr>";//操作
                }
            $("#tableBody").append(temp);


			$('.js-title').tooltipster();

           $(("[type='checkbox']")).iCheck({
                checkboxClass : 'icheckbox_square-blue',
                radioClass: 'iradio_square-blue'
            });

            //全选
            $('#allItem').on('ifChecked', function(event){
                $("input").iCheck('check');
            });
            //反选
            $('#allItem').on('ifUnchecked', function(event){
                $("input").iCheck('uncheck');
            });
            //iCheck for checkbox and radio inputs
           /* $('input[type="checkbox"].minimal, input[type="radio"].minimal').iCheck({
              checkboxClass: 'icheckbox_minimal-blue',
              radioClass   : 'iradio_minimal-blue'
            })*/
            }

             var pages=Math.ceil(count/pageSize);
             page={'total':count,'pageNum':pageIndex,'pages':pages};
             setPage(page,"init","show");
        }
     });
    }
 
function toExportHistory() {
     var wxMainIdVal=$("#wxMainIdSearch option:selected").val();
    if(!wxMainIdVal){
        alert("请先选择主号");
        return;
    }
    var wxIds = [];
    $('input[name="wxItem"]:checked').each(function() {
	    wxIds.push($(this).val());
    });

    if(wxIds.length<1){
        alert("请选择好友后再进行导出");
        return;
    }
    var startDate=$("#startDate").val();
    var endDate=$("#endDate").val();
    window.open( '/WXCRM/exportChatHistoryData?wxMainId='+wxMainIdVal+'&wxIds='+wxIds+'&startDate='+startDate+'&endDate='+endDate,'_blank');
   /* $.ajax({
        type: 'get',
        traditional:true,
        dataType: 'json',
        url: '/WXCRM/exportChatHistoryData',
        data: {
                "wxMainId":wxMainIdVal,
                "wxIds":wxIds
        },
        success: function (res) {}
     });*/
}    
</script>

</body>
</html>
