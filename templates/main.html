<!DOCTYPE html>
    {% load static  %}
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>慧聊</title>
  <!-- Tell the browser to be responsive to screen width -->
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="/static/plugins/font-awesome/css/font-awesome.min.css">

  <!-- Ionicons -->
  <link rel="stylesheet" href="/static/dist/css/ionicons.min.css">
  <!-- Theme style -->
  <link rel="stylesheet" href="/static/dist/css/adminlte.min.css">
  <!-- iCheck -->
  <link rel="stylesheet" href="/static/plugins/iCheck/flat/blue.css">
  <!-- jvectormap -->
  <link rel="stylesheet" href="/static/plugins/jvectormap/jquery-jvectormap-1.2.2.css">
  <!-- bootstrap wysihtml5 - text editor -->
  <link rel="stylesheet" href="/static/plugins/bootstrap-wysihtml5/bootstrap3-wysihtml5.min.css">
  <!-- Google Font: Source Sans Pro -->
  <link href="/static/dist/css/css.css?family=Source+Sans+Pro:300,400,400i,700" rel="stylesheet">
  <link rel="stylesheet" href="/static/css/wx.css">
  <link type="favicon" rel="shortcut icon" href="/static/fav.png" />
    <style>
        .dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            background-color: #f9f9f9;
            min-width: 160px;
            right: 0;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            padding: 12px 16px;
            z-index: 1;
        }

        .dropdown:hover .dropdown-content {
            display: block;
        }
        /* 下拉菜单的链接 */
.dropdown-content a {
    color: black;
    padding: 12px 16px;
    text-decoration: none;
    display: block;
}

/* 鼠标移上去后修改下拉菜单链接颜色 */
.dropdown-content a:hover {background-color: #f1f1f1}

/* 在鼠标移上去后显示下拉菜单 */
.dropdown:hover .dropdown-content {
    display: block;
}

/* 当下拉内容显示后修改下拉按钮的背景颜色 */
.dropdown:hover .dropbtn {
    background-color: #3e8e41;
}
    </style>
</head>
<body class="hold-transition sidebar-mini">
<div class="wrapper">

  <!-- Navbar -->
  <nav class="main-header navbar navbar-expand border-bottom navbar-light bg-gray-light">
    <!-- Left navbar links -->
    <ul class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link" data-widget="pushmenu" href="#"><i class="fa fa-bars"></i></a>
      </li>
    </ul>

    <!-- Right navbar links -->
    <ul class="navbar-nav ml-auto">
      <li class="user user-menu">
        <i class="nav-icon fa fa-user"></i>
        {% if request.session.oper_name %}
{#            <span class="hidden-xs"><a href="/user_ifo/" style="color:black;text-decoration:none;"> {{ request.session.oper_name }}</a></span>#}
            <div class="dropdown" style="float:right;">
              <span style="width:100%;text-align:center;display:block;Margin:1.5px;">   {{ request.session.oper_name }} </span>
              <div class="dropdown-content">
                  <a onclick="userInfo()">个人信息</a>
                  <a onclick="changePw()">更改密码</a>

              </div>
            </div>
        {% else %}
            <span class="hidden-xs">请重新登陆</span>
        {% endif %}
      </li>
      <li style="margin-left: 10px; cursor: pointer;">
        <a herf="#" onclick="logout()">退出</a>
      </li>
    </ul>

  </nav>
  <!-- /.navbar -->

  <!-- Main Sidebar Container -->
  <aside class="main-sidebar sidebar-dark-primary elevation-4">
    <!-- Brand Logo -->
    <a href="index.html" class="brand-link">
      <img src="/static/dist/img/AdminLTELogo.png" class="brand-image" style="opacity: .8">
    </a>

    <!-- Sidebar -->
    <div class="sidebar">

      <!-- Sidebar Menu -->
      <nav class="mt-2">
        <ul class="nav nav-pills nav-sidebar flex-column" data-widget="treeview" role="menu" data-accordion="false">
        {% for menu in menuList %}
            {% if menu.2 == '0' %}
                {% if menu.7 == 0 %}
                    <li class="nav-item">
                        <a href="javascript:menuClick('{{ menu.0 }}','{{ menu.4 }}')" class="nav-link">
                          <i class="nav-icon {{ menu.6 }}"></i>
                          <p name="menuname">
                            {{ menu.1 }}
                          </p>
                          <i id="chat_num" class="icon web_wechat_reddot_middle" style="color: #ffffff;font-size: 12px;font-style: normal;line-height: 15px;text-align: center;margin-top: -15px;">10</i>
                        </a>
                    </li>
                {% else %}
                  <li class="nav-item has-treeview {% if menu.0 == '1' %} menu-open{% endif %} ">
                    <a href="javascript:menuClick('{{ menu.0 }}','{{ menu.4 }}')" class="nav-link ">
                      <i class="nav-icon {{ menu.6 }}"></i>
                      <p name="menuname">
                         {{ menu.1 }}
                        <i class="right fa fa-angle-left"></i>
                      </p>
                    </a>
                    <ul class="nav nav-treeview">
                      {% for childMenu in menuList %}
                          {% if childMenu.2 == menu.0 %}
                          <li class="nav-item">
                            <a href="javascript:menuClick('{{ childMenu.0 }}','{{ childMenu.4 }}')" class="nav-link {{ childMenu.0 }}">
                              &nbsp;&nbsp;&nbsp;<i class="nav-icon {{ childMenu.6 }}"></i>
                              <p>{{ childMenu.1 }}</p>
                            </a>
                          </li>
                          {% endif %}
                      {% endfor %}
                    </ul>
                  </li>
            {% endif %}
            {% endif %}
        {% endfor %}
        </ul>
      </nav>
      <!-- /.sidebar-menu -->
    </div>
    <!-- /.sidebar -->
  </aside>

  <!-- Content Wrapper. Contains page content -->
  <div class="content-wrapper">


    <!-- Main content -->
    <section class="content">
      <!-- <div class="container-fluid"> -->
        <iframe id="mainFrame" name="mainFrame" src="/WXCRM/index" style="overflow:visible;background: #fff;" scrolling="auto"
                onload="loadFrame(this)" frameborder="no" width="100%" >
        </iframe>
        <!--</div> --><!-- /.container-fluid -->
    </section>
    <!-- /.content -->
  </div>
  <!-- /.content-wrapper -->
  <!-- Control Sidebar -->
  <aside class="control-sidebar control-sidebar-dark">
    <!-- Control sidebar content goes here -->
  </aside>
  <!-- /.control-sidebar -->
</div>
<!-- ./wrapper -->


{#定时计划查询modal#}
<div class="modal fade" id="Modal_User_Info" tabindex="-1" role="dialog" aria-labelledby="Modal_create1"
     aria-hidden="true" style="z-index:1100">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">

            <div class="modal-header">
                <h4 class="modal-title" id="scheduleGroupName">个人信息</h4>
            </div>
            <div class="card card-primary task_dialog">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-4" style="text-align:right;color: #7c859a;font-weight:bold;">
                            账号
                        </div>
                        <div class="col-8">
                            <input type='text' class="form-control" id='infoaccName' style="width: 60%;height:80%;" >
                        </div>
{#                        <div class="col-4" style="text-align:right;color: #7c859a;font-weight:bold;">#}
{#                            密码#}
{#                            <i class="fa fa-edit " title="修改" onclick="infoChange()" style="color: #ab1e1e"></i>#}
{#                        </div>#}
{#                        <div class="col-8">#}
{#                            <i class="fa fa-edit " title="修改" onclick="infoChange()"></i>#}
{#                        </div>#}
                        <div class="col-4" style="text-align:right;color: #7c859a;font-weight:bold;">
                            联系号码
{#                            <i class="fa fa-edit " title="修改" onclick="infoChange('1')" style="color: #ab1e1e"></i>#}
                        </div>
                        <div class="col-8" class="row">
{#                            <input type='text' class="form-control" id='infoPhone' style="width: 60%;height:80%;" value={{ request.session.oper_phone }}  >#}
                            <input type='text' class="form-control" id='infoPhone' style="width: 60%;height:80%;" >
                        </div>
                        <div class="col-4" style="text-align:right;color: #7c859a;font-weight:bold;">
                            姓名
{#                            <i class="fa fa-edit " title="修改" onclick="infoChange('2')" style="color: #ab1e1e"></i>#}
                        </div>
                        <div class="col-8">
                            <input type='text' class="form-control" id='infoViewName' style="width: 60%;height:80%;">
                        </div>
                        <div class="col-4" style="text-align:right;color: #7c859a;font-weight:bold;">
                            创建时间
                        </div>
                        <div class="col-8">
                             <input type='text' class="form-control" id='infoCreateTime' style="width: 60%;height:80%;" >
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal" >关闭</button>
                <button type="button" class="btn btn-primary" onclick='infoChange()'>修改</button>
            </div><!-- /.modal-content -->
        </div>
    </div><!-- /.modal -->
</div>

<div class="modal fade" id="Modal_PW_Change" tabindex="-1" role="dialog" aria-labelledby="Modal_create1"
     aria-hidden="true" style="z-index:1100">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">

            <div class="modal-header">
                <h4 class="modal-title" id="scheduleGroupName">更改密码</h4>
            </div>
            <div class="card card-primary task_dialog">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-4" style="text-align:right;color: #7c859a;font-weight:bold;">
                            你的当前密码

                        </div>
                        <div class="col-8" class="row">
{#                            <input type='text' class="form-control" id='infoPhone' style="width: 60%;height:80%;" value={{ request.session.oper_phone }}  >#}
                            <input type='password' class="form-control" id='pwChangeOri' style="width: 60%;height:80%;" placeholder="请填写当前密码">
                        </div>
                        <div class="col-4" style="text-align:right;color: #7c859a;font-weight:bold;">
                            输入新密码
                        </div>
                        <div class="col-8">
                            <input type='password' class="form-control" id='pwChangeMod' style="width: 60%;height:80%;"placeholder="请输入修改密码">
                        </div>
                        <div class="col-4" style="text-align:right;color: #7c859a;font-weight:bold;">
                            确认新密码
                        </div>
                        <div class="col-8">
                            <input type='password' class="form-control" id='pwChangeCon' style="width: 60%;height:80%;" placeholder="请确认修改密码">
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal" >关闭</button>
                <button type="button" class="btn btn-primary" onclick='pwChangeConfirm()'>确认</button>
            </div><!-- /.modal-content -->
        </div>
    </div><!-- /.modal -->
</div>

<!-- jQuery -->
<script src="/static/plugins/jquery/jquery.min.js"></script>
<!-- jQuery UI 1.11.4 -->
<script src="/static/plugins/jQueryUI/jquery-ui.min.js"></script>
<!-- Resolve conflict in jQuery UI tooltip with Bootstrap tooltip -->
<script>
  $.widget.bridge('uibutton', $.ui.button)
</script>
<!-- Bootstrap 4 -->
<script src="/static/plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
<!-- Slimscroll -->
<script src="/static/plugins/slimScroll/jquery.slimscroll.min.js"></script>
<!-- FastClick -->
<script src="/static/plugins/fastclick/fastclick.js"></script>
<!-- AdminLTE App -->
<script src="/static/dist/js/adminlte.js"></script>
<script src="/static/js/md5.js"></script>
<script src="/static/dist/js/demo.js"></script>
<script src="/static/js/common.js"></script>

<script>
$(function () {

   $("#chat_num").hide();
   setTimeout('getChat()', 1000);
});

function getChat() {
    $.ajax({
        url: "{% url 'newcount' %}",
        type: "GET",
        data: {},
        success: function (data) {
            severcheck(data);
            data = JSON.parse(data);
            if(data.newscount > 0){
                if(data.newscount > 99){
                    $("#chat_num").html("...");
                }
                else{
                    $("#chat_num").html(data.newscount);
                }

                $("#chat_num").show();
            }
            else{
                $("#chat_num").hide();
            }
        }
   });
   setTimeout('getChat()', 5000);
}

$("#mainFrame").height(window.innerHeight-10);
openchatflag=false;
function loadFrame(obj) {
  var url = obj.contentWindow.location.href;
  if(url.indexOf("/hl/") != -1){
    window.location.href=url;
  }
}
 //控制点击菜单后 子菜单的样式
function menuClick(menuId,link) {
  $(".nav-link").removeClass("active");
  $("."+menuId).addClass("active");
  if(link.indexOf('chat')!=-1&&link.indexOf('chatHistory')==-1&&link.indexOf('chatReport')==-1){
      targetUrl="http://" + window.document.location.host + link;
      /*if(openchatflag){
          if(confirm('聊天界面已经打开，是否需要再打开一个')){
              window.open(targetUrl);
          }
          return false;
      }
      else{*/
          window.open(targetUrl);
          //openchatflag=true;
      //}
  }
  else{
      mainFrame.location.href=link;
  }
}

function logout() {
    $.ajax({
        url: "{% url 'logout' %}",
        type: "POST",
        async:false,
        data: {},
        success: function (data) {
            window.location.href='http://'+window.location.host+'/hl/';
        }
    });
}
function changePw() {
    $("#pwChangeOri").val('');
    $("#pwChangeMod").val('');
    $("#pwChangeCon").val('');
    $("#Modal_PW_Change").modal("show");
}
function pwChangeConfirm(){
    if ($("#pwChangeOri").val() == "" || $("#pwChangeMod").val() == "" || $("#pwChangeCon").val() == ""){
        alert("内容不能为空")
        return false
    }
    var pwChangeOriVal = hex_md5($("#pwChangeOri").val());
    var pwChangeModVal = hex_md5($("#pwChangeMod").val());
    var pwChangeConVal = hex_md5($("#pwChangeCon").val());
    if (pwChangeModVal == ""){
        alert("修改密码不能为空")
        return false
    }else {
        var pwdValid = passwordValidCheck($("#pwChangeMod").val())
        if (!pwdValid){
            return false
        }
    }
    if (pwChangeModVal != pwChangeConVal){
        alert("请确认修改密码一致")
    }else{
        $.ajax({
        url: "{% url 'pwChangeConfirm' %}",
        type: "GET",
        data: {"pwChangeOriVal": pwChangeOriVal,
                "pwChangeModVal": pwChangeModVal},
        success: function (data) {
            severcheck(data);
            data = Json.parse(data);
            var retStatus = data['retStatus']
            if (retStatus == 1) {
                alert("密码修改成功")
            }else if (retStatus == -1){
                alert("密码修改故障")
            }else if (retStatus == -2){
                alert("请确认当前密码正确")
            }
        }
    })
    }
}
function userInfo() {
    {#$("#infoPhone").attr("disabled","disabled");#}
    {#$("#infoMail").attr('disabled',"disabled");#}
    $.ajax({
        url: "{% url 'infoCheck' %}",
        type: "GET",
        data: {},
        success: function (data) {
            severcheck(data);
            data = JSON.parse(data);
            var oriPhoneGet = data['oriPhone'];
            var oriCreateTime = data['oriCreateTime'];
            var oriViewName = data['oriViewName'];
            var oriName = data['oriName'];
            $("#infoPhone").val(oriPhoneGet);
            $("#infoViewName").val(oriViewName);
            $("#infoCreateTime").val(oriCreateTime);
            $("#infoaccName").val(oriName);
            $("#infoaccName").attr("disabled","disabled");
            $("#infoCreateTime").attr("disabled","disabled");
        }
    })
    $("#Modal_User_Info").modal("show");
}
function infoChange(){

    var infoPhone = $("#infoPhone").val();
    var infoViewName = $("#infoViewName").val();
    var infoaccName = $("#infoaccName").val();

    if (infoPhone == ""){
        alert("手机号不能为空")
        return false
    }
    if (infoViewName == ""){
        alert("姓名不能为空")
        return false
    }
    var phoneCheckFlag = phoneCheck(infoPhone)
    var viewnameCheckFlag = isChnCheck(infoViewName)
    if (! phoneCheckFlag){
        alert("手机号码不符合要求")
        return false
    }
    if (! viewnameCheckFlag){
        alert("姓名不符合要求,需为中文")
        return false
    }
    var infoConfirmFlag =confirm("确认进行信息修改？");
    if (infoConfirmFlag == false){
        return false
    }else{
        $.ajax({
        url: "{% url 'infoModifyMain' %}",
        type: "GET",
        data: {"infoaccName":infoaccName,
                "infoPhone":infoPhone,
                "infoViewName":infoViewName},

        success: function (data) {
            severcheck(data);
            data = Json.parse(data);
            if (data['retStatus'] == 1) {
                alert('修改成功');
            }else {
                alert('信息修改错误')
            }
        }
    })
    }

}

function passwordValidCheck(password)
    {
        if(password.length < 6 || password.length >18 ){
            alert("密码长度不符合要求，必须6-18个字符")
            return false;
        }
        var isNumber=0;
        var ischar=0;
        var isOther=0;
        for (i=0;i<password.length;i++){
            //密码模式
            iN = password.charCodeAt(i);
            //判断输入密码的类型
            if (iN>=48 && iN <=57) //数字
                isNumber=1;
            else if (iN>=65 && iN <=90) //大写
                ischar=1;
            else if (iN>=97 && iN <=122) //小写
                ischar=1;
            else
                isOther=1;
        }
        if (isNumber+ischar+isOther<=1){
            alert("不能单独使用字母、数字和符号")
            return false;
        }
        return true;
    }
    function phoneCheck(infoPhoneGet) {
        var phoneReg = /^(((13[0-9]{1})|(15[0-9]{1})|(18[0-9]{1})|(17[0-9]{1}))+\d{8})$/;
        if (phoneReg.test(infoPhoneGet)) {
            return true;
        } else {

            return false;
        }
    }
    function isChnCheck(infoNameGet) {
        {#var reg = /.*[\\u4e00-\\u9fa5]+.*$/;#}
        var reg = new RegExp("[\\u4E00-\\u9FFF]+","g");
        if (reg.test(infoNameGet)) {
            return true;
        } else {
            return false;
        }
    }
</script>

</body>
</html>
