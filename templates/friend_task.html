<!DOCTYPE html>
<html lang="en">
<head>
    <!-- TITLE OF SITE -->
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>一键加好友</title>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description"  content="Cleannit - Cleaning Company HTML Template" />
    <meta name="keywords"     content=" cleannit, parallax, one page, multipage, responsive, landing, html template" />
    <meta name="author"       content=" cleannit">
    <meta name="viewport"     content="width=device-width, initial-scale=1, maximum-scale=1">

    <!-- Favicons -->
    <script src="/static/plugins/jquery/jquery.min.js"></script>
    <script type="text/javascript"></script>
    <!-- CSS Begins
================================================== -->

    <!-- Main Style -->
    <link href="/static/css/onekey/friend_task.css" rel="stylesheet">

</head>

<body>
    <script type="text/javascript">
     $(document).ready(function(){
        init();
        startRequest(1);
        sleep(500);
        setInterval("startRequest(2)", 2000); //0.5s
     });

     function init() {
         var taskid=$("#taskid").val();
         //consle.log(String(taskid));
         $.ajax({
             type: "POST",
             url: "/friend_task/",
             dataType: "json",
             async: false,
             data: {'taskid':String(taskid)},
             success: function(data) {
                 $('#taskSpan').append(data.task);
                 $('#addrDiv').append(data.addr);
                 $('#tmtDiv').append(data.tmt);
                 $('#jobDiv').append(data.job);
                 $('#sexDiv').append(data.sex);
                 $('#ageDiv').append(data.age);
                 $('#consumeDiv').append(data.consume);
                 //$('#flagDiv').append(data.flag);
                 $('#addAddrDiv').append(data.addAddr);
                 $('#addTimeDiv').append(data.addTime);
                 $('#greetDiv').append(data.greet);
                 $('#remarkDiv').append(data.remark);
                 $('#taskcnt').append(data.taskcnt);
                 $('#exectime').val(data.exectime);
                 taskstate=data.taskstate;

                 straa=data.flag
                 console.log('straa:'+straa)
                 if(straa!='不限'){
                 flagAtr=straa.split(',');
                   for (i  in  flagAtr){
                        //console.log(i);
                       flagstr='<span class="flagcls">'+flagAtr[i]+'</span>';
                       $('#flagDiv').append(flagstr);
                    };
                  }
                  else{$('#flagDiv').append('不限');}

                 if(taskstate=='1'){$("#pauseOrstart").val('暂停');}
                 else if(taskstate=='2'){$("#pauseOrstart").val('继续');}
                 else{
                      $("#stopTask").attr("disabled", true);
                      $("#pauseOrstart").attr("disabled", true);
                      document.getElementById("stopTask").style.background="#ADADAD";
                      document.getElementById("pauseOrstart").style.background="#ADADAD";
                 }

             },
             error: function(data){
                  console.log("init()发生错误")
             }
         });
     }

     function startRequest(loadcnt) {
         exectime=$('#exectime').val();
         sendtime=$('#sendtime').val();
         passtime=$('#passtime').val();
         //console.log("exectime:"+exectime)
         if(exectime=="")
         {querytime=gettime()}
         else
          {querytime=exectime}

         if (loadcnt!=1) {
             querytime = gettime()
         }
         //console.log("querytime :"+querytime);
         var taskid=$("#taskid").val();
        $.ajax({
            url: "/task_schedule/",
            type: 'POST',
	        dataType : 'json',
            data: {'taskid': taskid,'querytime':querytime ,'loadcnt':loadcnt,'sendtime':sendtime,'passtime':passtime},
            success: function (data) {
                $('#sendtime').val(data.sendtime);
                $('#passtime').val(data.passtime);
                $("#sendcnt").html("")
                $("#sendcnt").append(data.sendcnt)
                $("#passcnt").html("")
                $("#passcnt").append(data.passcnt)
                data=data.listmsg
                for (i in data){
                    console.log(data[i].ctype);
                    str=""
                    if(data[i].ctype=='1'){str='<p style="color:red">'}
                    else{str='<p style="color:blue">'}
                    str=str+data[i].optime+"&nbsp&nbsp&nbsp&nbsp"+"&lt;"+ data[i].wx+"&gt;"+data[i].msg+"</p>"
                    //console.log(i);
                    $("#chatresult").append(str)
                }

               // $("#chatresult").append(str)
            },
	        error : function(data) {
		        //alert("发生错误：" );
                console.log("startRequest()发生错误")
	        }
        });
     }

     function gettime() {
         var date=new Date();
         var year=date.getFullYear(); //获取当前年份
         var mon=date.getMonth()+1; //获取当前月份
         var da=date.getDate(); //获取当前日
         var day=date.getDay(); //获取当前星期几
         var h=date.getHours(); //获取小时
         var m=date.getMinutes(); //获取分钟
         var s=date.getSeconds(); //获取秒
         if (da<10){da='0'+String(da)};
         if (m<10){m='0'+String(m)};
         if (h<10){h='0'+String(h)};
         if (mon<10){mon='0'+String(mon)};
         if (s<10){s='0'+String(s)};
         curtime=String(year)+String(mon)+String(da)+String(h)+String(m)+String(s);
         return curtime
     }

      function sleep(n) {
        var start = new Date().getTime();
        //  console.log('休眠前：' + start);
        while (true) {
            if (new Date().getTime() - start > n) {
                break;
            }
        }   // console.log('休眠后：' + new Date().getTime());
      }

      function change_task(int) {
          taskstate=$("#pauseOrstart").val();
          taskid=$("#taskid").val();
          task_state='1'
          if (int==1){
              task_state='3';}
          else if(taskstate=='暂停'){
              task_state='2';
          }
          else if(taskstate=='继续'){
              task_state='1';
          }
          else{return}

          $.ajax({
            url: "/change_task/",
            type: 'POST',
	        dataType : 'json',
            data: {'taskid': taskid,'task_state':task_state },
            success: function (data) {

                  if (task_state=='3'){
                      alert("已终止！");
                      $("#stopTask").attr("disabled", true);
                      document.getElementById("stopTask").style.background="#ADADAD";
                      $("#pauseOrstart").attr("disabled", true);
                      document.getElementById("pauseOrstart").style.background="#ADADAD";


                  }
                   else if(task_state=='2'){
                       alert("暂停成功！");
                       $("#pauseOrstart").val('继续');
                  }
                   else if(task_state=='1'){
                       alert("已重新启动！");
                       $("#pauseOrstart").val('暂停');
                  }
            },
	        error : function(data) {
		        alert("变更状态发生错误！")
                console.log("change_task()发生错误")
	        }
        });


      }


    </script>



    <div class="friend_content">
        <input id="taskid"    value="{{taskid}}"  type="hidden"/>
        <input id="exectime"  value=""  type="hidden"/>
        <input id="sendtime"  value=""  type="hidden"/>
        <input id="passtime"  value=""  type="hidden"/>
        <span class="s2" id="taskSpan"></span>
        <div class="friend_miaosu">
            <div class="s1"><span>好友描述</span></div>
            <div class="miaosu_c">
                <table class="about_table" border="0"  cellspacing="0" cellpadding="0">
                    <tr>
                    <td min-width= "5%"  style="width: 50px"><div class="about_para">区域:</div></td>
                    <td min-width= "50%" class="tb_line"><div class="about_para1" id="addrDiv"></div></td>
                    </tr>
                    <tr>
                    <td><div class="about_para"  >行业:</div></td>
                    <td class="tb_line"><div class="about_para1" id="tmtDiv" ></div></td>
                    </tr>
                    <tr>
                    <td><div class="about_para">职业:</div></td>
                    <td class="tb_line"><div class="about_para1" id="jobDiv"></div></td>
                    </tr>
                    <tr>
                    <td><div class="about_para" >性别:</div></td>
                    <td class="tb_line"><div class="about_para1"  id="sexDiv"></div></td>
                    </tr>
                </table>
            </div>

            <div class="miaosu_c">
                <table class="about_table" border="0"  cellspacing="0" cellpadding="0">
                    <tr>
                    <td min-width= "5%" style="width: 50px"><div class="about_para">年龄:</div></td>
                    <td min-width= "50%" class="tb_line"><div class="about_para1" id="ageDiv"></div></td>
                    </tr>
                    <tr>
                    <td><div class="about_para">消费:</div></td>
                    <td class="tb_line"><div class="about_para1" id="consumeDiv"></div></td>
                    </tr>
                    <tr>
                    <td><div class="about_para">标签:</div></td>
                    <td class="tb_line"><div class="about_para1" id="flagDiv"></div></td>
                    </tr>
                </table>
            </div>
        </div>
        <div class="friend_add">
        <div class="s1"><span>好友添加</span></div>
        <div class="miaosu_c">
                <table class="about_table" border="0"  cellspacing="0" cellpadding="0">
                    <tr>
                    <td min-width= "5%" style="width: 120px"><div class="about_para">好友添加到:</div></td>
                    <td min-width= "50%" class="tb_line"><div class="about_para1" id="addAddrDiv"></div></td>
                    </tr>
                    <tr>
                    <td><div class="about_para">好友添加时间:</div></td>
                    <td class="tb_line"><div class="about_para1" id="addTimeDiv"></div></td>
                    </tr>
                </table>
            </div>

            <div class="miaosu_c">
                <table class="about_table" border="0"  cellspacing="0" cellpadding="0">
                    <tr>
                    <td min-width= "5%" style="width: 100px"><div class="about_para">好友招呼语:</div></td>
                    <td min-width= "50%" class="tb_line"><div class="about_para1" id="greetDiv"></div></td>

                    </tr>
                </table>
            </div>
        </div>

        <div class="friend_jd">
        <div class="s1"><span>添加进度</span></div>
        <div  class="containerDiv" style="width:804px;height:58px;border:2px solid #f9f9f9;margin:30px 0 0 50px;border-radius:3px;">
                   <div class="childDiv"><span>好友添加量：</span><span id="taskcnt"></span>个</div>
                   <div class="childDiv"><span>已发起添加：</span><span id="sendcnt"></span>个</div>
                   <div class="childDiv"><span>已通过好友：</span><span id="passcnt"></span>个</div>
        </div>
                <div id="chatresult"   >
            </div>
        </div>

        <div class="friend_remark">
        <div class="s1"><span style="text-align:left">备注</span></div>
            <div id="remarkDiv" class="remarkc"></div>
        </div>

    </div>

    <div class="friend_bottom">
            <input type="button" id="pauseOrstart" class="button1" onclick="change_task(0)" value="暂停"></input>
            <input type="button" id="stopTask" class="button2" onclick="change_task(1)" value="终止"></input>
            <input type="button" id="" class="button1"  value="返回" onclick="javascript:history.back(-1);"></input>
    </div>


</body>

</html>